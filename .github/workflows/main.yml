name: Simple Repository Deployment

on:
  push:
    branches: [ main, test ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Create clean source archive
      run: |
        echo "Creating source code archive..."

        # Create archive directly from current directory, excluding unwanted files
        tar --exclude='.git' \
            --exclude='.github' \
            --exclude='bin' \
            --exclude='obj' \
            --exclude='*/bin' \
            --exclude='*/obj' \
            --exclude='*.user' \
            --exclude='.vs' \
            --exclude='.vscode' \
            --exclude='node_modules' \
            --exclude='source-code.tar.gz' \
            -czf source-code.tar.gz .

        echo "Archive created:"
        ls -la source-code.tar.gz
        echo "Archive size:"
        du -h source-code.tar.gz

    - name: Upload and extract source code
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HETZNER_HOST }}
        username: ${{ secrets.HETZNER_USER }}
        password: ${{ secrets.SSH_PRIVATE_KEY_USER_PW }}
        timeout: 300s
        script: |
          echo "=== Starting Repository Deployment ==="

          # Create backup if directory exists
          if [ -d "/var/www/cmc-app" ]; then
            mv /var/www/cmc-app /var/www/cmc-app-backup-$(date +%Y%m%d_%H%M%S)
            echo "Created backup"
          fi

          # Create target directory
          mkdir -p /var/www/cmc-app
          cd /var/www/cmc-app

          echo "=== Directory prepared ==="

    - name: Upload source code
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HETZNER_HOST }}
        username: ${{ secrets.HETZNER_USER }}
        password: ${{ secrets.SSH_PRIVATE_KEY_USER_PW }}
        source: "source-code.tar.gz"
        target: "/tmp/"
        timeout: 60s
        overwrite: true

    - name: Extract and finalize
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HETZNER_HOST }}
        username: ${{ secrets.HETZNER_USER }}
        password: ${{ secrets.SSH_PRIVATE_KEY_USER_PW }}
        timeout: 300s
        script: |
          echo "=== Extracting source code ==="

          # Extract source code to target directory
          cd /var/www/cmc-app
          tar -xzf /tmp/source-code.tar.gz

          echo "Source code extracted. Contents:"
          ls -la

          # Set proper permissions
          chown -R $USER:$USER /var/www/cmc-app

          # Clean up
          rm /tmp/source-code.tar.gz

          echo "=== Deployment Complete ==="
          echo "Repository content is now in /var/www/cmc-app/"
