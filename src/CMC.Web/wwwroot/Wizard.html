<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Multistep Formular – Status-Badges & Score</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <main class="max-w-5xl mx-auto p-6">
      <header class="mb-6">
        <h1 class="text-2xl font-bold">Selbstauskunft: Unternehmen & Sicherheitskontrollen</h1>
        <p class="text-sm text-slate-600 mt-1">Onboarding-Wizard</p>
      </header>

      <!-- Sticky Progress -->
      <section aria-label="Formularfortschritt" class="mb-6 sticky top-0 z-50 bg-slate-50/80 backdrop-blur pt-4 pb-3">
        <div class="flex items-center justify-between">
          <div class="flex-1 mr-4">
            <div class="w-full bg-slate-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%;"></div>
            </div>
          </div>
          <div class="text-sm font-medium text-slate-700">Schritt <span id="stepIndex">1</span>/<span id="stepTotal">4</span> · <span id="progressPct">0%</span></div>
        </div>
        <ol class="mt-3 grid grid-cols-4 gap-2 text-xs text-center">
          <li id="navStep1" class="py-2 rounded-lg bg-blue-50 text-blue-700 ring-1 ring-blue-200">1. Unternehmen</li>
          <li id="navStep2" class="py-2 rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200">2. Kontrollen</li>
          <li id="navStep3" class="py-2 rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200">3. Prüfen</li>
          <li id="navStep4" class="py-2 rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200">4. Übersicht & Score</li>
        </ol>
      </section>

      <form id="multiForm" class="bg-white rounded-2xl shadow p-6 space-y-8" novalidate>
        <!-- STEP 1 -->
        <section data-step="1" class="step">
          <h2 class="text-lg font-semibold mb-4">Unternehmensdaten</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="companyName">Unternehmensname <span class="text-red-600">*</span></label>
              <input id="companyName" name="companyName" required class="w-full rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600" placeholder="Beispiel GmbH"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="industry">Branche <span class="text-red-600">*</span></label>
              <select id="industry" name="industry" required class="w-full rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600">
                <option value="">Bitte wählen…</option>
                <option>IT & Software</option><option>Finanzen</option><option>Gesundheitswesen</option>
                <option>Industrie</option><option>Einzelhandel / E‑Commerce</option><option>Öffentlicher Sektor</option>
                <option>Beratung</option><option>Sonstige</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="revenue">Jahresumsatz (EUR) <span class="text-red-600">*</span></label>
              <input id="revenue" name="revenue" type="number" min="0" step="1000" required class="w-full rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600" placeholder="1000000"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="employees">Mitarbeiterzahl <span class="text-red-600">*</span></label>
              <input id="employees" name="employees" type="number" min="1" step="1" required class="w-full rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600" placeholder="50"/>
            </div>
          </div>
        </section>

        <!-- STEP 2: Kontrollen -->
        <section data-step="2" class="step hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Sicherheitskontrollen</h2>
            <span class="text-sm text-slate-600">Beantwortet: <span id="controlsCount">0</span>/25</span>
          </div>
          <div id="controlsContainer" class="space-y-3"></div>
          <p class="text-xs text-slate-500">Antworten zählen auch bei „Nein“ bzw. 0 % – Hauptsache beantwortet.</p>
        </section>

        <!-- STEP 3: Review -->
        <section data-step="3" class="step hidden">
          <h2 class="text-lg font-semibold mb-4">Prüfen & Absenden</h2>
          <div class="space-y-6">
            <div class="rounded-xl border border-slate-200 p-4">
              <h3 class="font-medium mb-2">Unternehmensdaten</h3>
              <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div><dt class="text-slate-500">Name</dt><dd id="reviewCompany" class="font-medium"></dd></div>
                <div><dt class="text-slate-500">Branche</dt><dd id="reviewIndustry" class="font-medium"></dd></div>
                <div><dt class="text-slate-500">Umsatz</dt><dd id="reviewRevenue" class="font-medium"></dd></div>
                <div><dt class="text-slate-500">Mitarbeiter</dt><dd id="reviewEmployees" class="font-medium"></dd></div>
              </dl>
            </div>
            <div class="rounded-xl border border-slate-200 p-4">
              <h3 class="font-medium mb-2">Kontrollen (<span id="reviewControlsCount">0</span>/25 beantwortet)</h3>
              <ul id="reviewControls" class="text-sm space-y-2"></ul>
            </div>
          </div>
        </section>

        <!-- STEP 4: Übersicht & Score -->
        <section data-step="4" class="step hidden">
          <h2 class="text-lg font-semibold mb-4">Übersicht nach Bereichen & Score</h2>
          <div id="scoreSummary" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          <div class="mt-4 p-4 rounded-xl border border-slate-200">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium">Gesamt-Score</span>
              <span id="overallPct" class="text-sm text-slate-600">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
              <div id="overallBar" class="bg-emerald-600 h-2 rounded-full transition-all" style="width:0%"></div>
            </div>
          </div>
        </section>

        <!-- Nav -->
        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btnPrev" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-40" disabled>Zurück</button>
          <div class="flex items-center gap-3">
            <button type="button" id="btnSaveDraft" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50">Zwischenspeichern</button>
            <button type="button" id="btnNext" class="px-5 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-400">Weiter</button>
            <button type="submit" id="btnSubmit" class="hidden px-5 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-400">Absenden</button>
          </div>
        </div>
      </form>

      <div id="success" class="hidden mt-6 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-800">
        <p class="font-medium">Danke! Deine Angaben wurden übermittelt.</p>
      </div>
    </main>

    <script>
      const form = document.getElementById('multiForm');
      const steps = Array.from(document.querySelectorAll('.step'));
      const totalSteps = steps.length;
      const progressBar = document.getElementById('progressBar');
      const progressPctEl = document.getElementById('progressPct');
      const stepIndexEl = document.getElementById('stepIndex');
      const stepTotalEl = document.getElementById('stepTotal');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const btnSubmit = document.getElementById('btnSubmit');
      const btnSaveDraft = document.getElementById('btnSaveDraft');
      const controlsCountEl = document.getElementById('controlsCount');
      const reviewControlsCountEl = document.getElementById('reviewControlsCount');
      const navStepEls = [document.getElementById('navStep1'),document.getElementById('navStep2'),document.getElementById('navStep3'),document.getElementById('navStep4')];

      let current = 0; stepTotalEl.textContent = totalSteps;

      // --- Kontrollen (25) ---
      const CONTROLS = [
        { id:'MFA', name:'MFA aktiviert', desc:'Mehr-Faktor-Authentifizierung für alle Benutzer?', type:'boolean', group:'Identity & Access', long:'MFA reduziert das Risiko kompromittierter Passwörter erheblich. Empfohlen für alle Konten inkl. Admin, VPN und Drittanbieterdienste.' },
        { id:'PasswordPolicy', name:'Passwort-Richtlinie', desc:'Mindestlänge, Komplexität, Rotation?', type:'select', options:['Nicht definiert','Basis','Streng'], group:'Identity & Access', long:'Definierte Richtlinien (z. B. Länge, Komplexität, Sperrungen) senken Kontoübernahmen.' },
        { id:'SSO', name:'SSO im Einsatz', desc:'Zentralisiertes Login via IdP?', type:'boolean', group:'Identity & Access', long:'Zentralisiertes Identitätsmanagement mit SSO erleichtert Durchsetzung und Audits.' },
        { id:'EDR', name:'Endpoint-Schutz (EDR)', desc:'AV/EDR auf Clients & Servern?', type:'select', options:['Nein','Teilweise','Vollständig'], group:'Endpoint & Infrastruktur', long:'EDR erkennt und blockiert verdächtige Aktivitäten auf Endpunkten in Echtzeit.' },
        { id:'Patching', name:'Patch-Management', desc:'Regelmäßige Sicherheitsupdates?', type:'slider', group:'Endpoint & Infrastruktur', long:'Zeitnahes Patchen schließt bekannte Schwachstellen. Metrik = Abdeckung in %.' },
        { id:'DiskEnc', name:'Geräteverschlüsselung', desc:'Verschlüsselung auf Laptops/Servern?', type:'boolean', group:'Endpoint & Infrastruktur', long:'Geräteverschlüsselung schützt Daten bei Verlust/Diebstahl.' },
        { id:'EmailSec', name:'E-Mail-Sicherheit', desc:'Spam/Phishing-Filter, DMARC, DKIM?', type:'select', options:['Nein','Teilweise','Umfassend'], group:'Netzwerk & Cloud', long:'Mehrschichtige E-Mail-Sicherheit reduziert Phishing-Risiken.' },
        { id:'Awareness', name:'Security Awareness', desc:'Regelmäßige Trainings & Phishing-Tests?', type:'slider', group:'Governance & Prozesse', long:'Trainings erhöhen das Sicherheitsbewusstsein und reduzieren Klick-Raten.' },
        { id:'NetSeg', name:'Netzwerksegmentierung', desc:'Trennung sensibler Netze?', type:'select', options:['Nein','In Planung','Implementiert'], group:'Netzwerk & Cloud', long:'Segmentierung begrenzt Laterale Bewegung und reduziert Impact.' },
        { id:'Firewall', name:'Next-Gen-Firewall', desc:'Stateful/NGFW an Perimeter?', type:'boolean', group:'Netzwerk & Cloud', long:'NGFW ermöglicht Layer‑7‑Kontrollen, App‑Filter und IPS.' },
        { id:'IDSIPS', name:'IDS/IPS', desc:'Erkennung/Verhinderung von Angriffen?', type:'select', options:['Nein','IDS','IDS+IPS'], group:'Detection & Response', long:'Angriffe erkennen (IDS) und aktiv verhindern (IPS).' },
        { id:'VPN', name:'Sicheres Remote-Access', desc:'VPN/ZTA für Remote?', type:'boolean', group:'Netzwerk & Cloud', long:'Sicherer Remotezugang schützt externe Verbindungen.' },
        { id:'Backups', name:'Backups', desc:'Regelmäßig & getestet (Restore-Tests)?', type:'slider', group:'Governance & Prozesse', long:'Getestete Backups sind zentral für Resilienz und Ransomware‑Recovery.' },
        { id:'DRP', name:'Disaster Recovery Plan', desc:'Dokumentiert & getestet?', type:'select', options:['Nein','Dokumentiert','Getestet'], group:'Governance & Prozesse', long:'Ein geübter DR‑Plan verkürzt Ausfallzeiten.' },
        { id:'CSPM', name:'Cloud Security Posture', desc:'Automatisierte Cloud-Härtung?', type:'select', options:['Nein','Teilweise','Vollständig'], group:'Netzwerk & Cloud', long:'CSPM findet Fehlkonfigurationen in Cloud‑Umgebungen.' },
        { id:'SIEM', name:'Zentrales Logging/SIEM', desc:'Korrelation & Alarme?', type:'select', options:['Nein','Teilweise','24/7'], group:'Detection & Response', long:'SIEM korreliert Logs und erzeugt verwertbare Alarme.' },
        { id:'AccessReviews', name:'Zugriffs-Reviews', desc:'Regelmäßige Überprüfung von Rechten?', type:'slider', group:'Identity & Access', long:'Periodische Reviews verhindern Rechte‑Wildwuchs und überprivilegierte Konten.' },
        { id:'LeastPrivilege', name:'Least Privilege', desc:'Rollenbasiert, Privilege Mgmt?', type:'select', options:['Nein','Teilweise','Umgesetzt'], group:'Identity & Access', long:'Minimalprinzip reduziert Angriffsfläche erheblich.' },
        { id:'VendorRisk', name:'Lieferanten-Risiko', desc:'Drittparteien bewertet/überwacht?', type:'select', options:['Nein','Basis','Reif'], group:'Governance & Prozesse', long:'TPRM adressiert Risiken aus der Lieferkette.' },
        { id:'DLP', name:'Data Loss Prevention', desc:'DLP-Policies & Monitoring?', type:'select', options:['Nein','Teilweise','Umfassend'], group:'Governance & Prozesse', long:'DLP verhindert unbefugte Datenabflüsse.' },
        { id:'MDM', name:'Mobile Device Mgmt', desc:'MDM/MAM für BYOD/Firmengeräte?', type:'boolean', group:'Endpoint & Infrastruktur', long:'MDM setzt Sicherheitsrichtlinien auf mobilen Geräten durch.' },
        { id:'SDLC', name:'Sicherer SDLC', desc:'Code Reviews, SAST/DAST?', type:'slider', group:'Governance & Prozesse', long:'Sicherheitsprüfung integriert in den Entwicklungsprozess.' },
        { id:'VulnScan', name:'Vuln Scans', desc:'Regelmäßige Scans & Remediation?', type:'slider', group:'Detection & Response', long:'Regelmäßige Scans decken Schwachstellen früh auf.' },
        { id:'IRP', name:'Incident Response', desc:'IR-Playbooks & Übungen?', type:'select', options:['Nein','Dokumentiert','Geübt'], group:'Detection & Response', long:'Geübte IR‑Prozesse beschleunigen Eindämmung und Forensik.' },
        { id:'Secrets', name:'Secrets Management', desc:'Tresor/Rotation von Secrets?', type:'boolean', group:'Identity & Access', long:'Sichere Verwahrung und Rotation von Schlüsseln/Passwörtern.' },
      ];

      function inputFor(ctrl){
        const name = `ctrl_${ctrl.id}`;
        if (ctrl.type === 'boolean'){
          return `
            <fieldset class="inline-flex rounded-xl border border-slate-300 overflow-hidden">
              <label class="px-3 py-1.5 text-sm cursor-pointer">
                <input class="sr-only" type="radio" name="${name}" value="Ja">
                <span class="seg">Ja</span>
              </label>
              <label class="px-3 py-1.5 text-sm cursor-pointer border-l border-slate-300">
                <input class="sr-only" type="radio" name="${name}" value="Nein">
                <span class="seg">Nein</span>
              </label>
            </fieldset>
            <p class="text-[11px] text-slate-500 mt-1">Ja/Nein – beides zählt als beantwortet.</p>`;
        }
        if (ctrl.type === 'select'){
          const opts = [''].concat(ctrl.options||[]).map((o,i)=>`<option value="${i?o:''}">${i?o:'Bitte wählen…'}</option>`).join('');
          return `<select name="${name}" class="w-full rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600">${opts}</select>`;
        }
        return `<div class="space-y-1"><input type="range" min="0" max="100" step="5" value="0" name="${name}" class="w-full"><div class="text-xs text-slate-600"><span class="sliderVal">0</span>% Abdeckung</div></div>`;
      }

      function controlCard(ctrl){
        return `<div class=\"relative p-4 rounded-2xl border border-slate-200 bg-white shadow-sm\" data-control-id=\"${ctrl.id}\">\n          <div class=\"grid grid-cols-1 md:grid-cols-7 gap-3 items-start\">\n            <div class=\"md:col-span-3\">\n              <div class=\"flex items-start gap-2\">\n                <h4 class=\"text-sm font-semibold\">${ctrl.name}</h4>\n                <span class=\"mt-0.5 inline-flex items-center text-[10px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-600 ring-1 ring-slate-200\">${ctrl.group}</span>\n              </div>\n              <p class=\"text-xs text-slate-600 mt-1\">${ctrl.desc}</p>\n            </div>\n            <div class=\"md:col-span-2\">${inputFor(ctrl)}</div>\n            <div class=\"md:col-span-2 text-xs text-slate-600\">${ctrl.long}</div>\n          </div>\n        </div>`;
      }

      function renderControls(){
        const wrap = document.getElementById('controlsContainer');
        wrap.innerHTML = CONTROLS.map(controlCard).join('');
        // Radio styling
        wrap.addEventListener('change', (e)=>{
          if (e.target && e.target.type === 'radio'){
            const group = e.target.name;
            const radios = wrap.querySelectorAll(`input[name="${group}"]`);
            radios.forEach(inp=>{
              const span = inp.parentElement.querySelector('.seg');
              if (span){
                span.className = 'seg';
                span.classList.toggle('bg-blue-600', inp.checked);
                span.classList.toggle('text-white', inp.checked);
              }
            });
            updateControlsCount(); updateProgress();
          }
        });
        wrap.querySelectorAll('input[type="range"]').forEach(el=>{
          const label = el.closest('div').querySelector('.sliderVal');
          el.addEventListener('input', ()=>{ label.textContent = el.value; updateControlsCount(); updateProgress(); });
        });
        wrap.querySelectorAll('select').forEach(el=>{
          el.addEventListener('change', ()=>{ updateControlsCount(); updateProgress(); });
        });
      }

      function showStep(index){
        steps.forEach((el,i)=> el.classList.toggle('hidden', i!==index));
        current = index; stepIndexEl.textContent = String(current+1);
        btnPrev.disabled = current===0;
        btnNext.classList.toggle('hidden', current===totalSteps-1);
        btnSubmit.classList.toggle('hidden', current!==totalSteps-1);
        navStepEls.forEach((el,i)=>{el.className = i===current ? 'py-2 rounded-lg bg-blue-50 text-blue-700 ring-1 ring-blue-200' : 'py-2 rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200';});
        if (current===2) fillReview();
        if (current===3) renderScores();
        updateProgress();
      }

      function validateStep1(){
        const required = ['companyName','industry','revenue','employees'];
        let ok = true; required.forEach(id=>{const el=document.getElementById(id); if(!el.value){el.classList.add('ring-2','ring-red-400'); ok=false;} else {el.classList.remove('ring-2','ring-red-400');}}); return ok;
      }

      function isAnswered(input){
        if (!input) return false;
        if (input.type==='radio'){ return !!document.querySelector(`input[name="${input.name}"]:checked`); }
        if (input.tagName==='SELECT'){ return input.value!==''; }
        if (input.type==='range'){ return true; } // 0–100 zählt als beantwortet
        return false;
      }

      function updateControlsCount(){
        const cards = Array.from(document.querySelectorAll('#controlsContainer > div'));
        let answered = 0;
        cards.forEach(card=>{
          const input = card.querySelector('input, select');
          if (isAnswered(input)) answered++;
        });
        controlsCountEl.textContent = Math.min(answered, 25);
      }

      function calcProgress(){
        const required = ['companyName','industry','revenue','employees'];
        const reqDone = required.reduce((a,id)=>a + (document.getElementById(id).value?1:0), 0);
        const cards = Array.from(document.querySelectorAll('#controlsContainer > div'));
        const answered = cards.reduce((a,card)=>{const input=card.querySelector('input, select'); return a + (isAnswered(input)?1:0);},0);
        const total = 4 + 25; // 4 Pflichtfelder + 25 Kontrollen
        return Math.round(((reqDone + Math.min(answered,25)) / total) * 100);
      }
      function updateProgress(){
        const pct = calcProgress();
        progressBar.style.width = pct + '%';
        progressPctEl.textContent = pct + '%';
      }

      function fillReview(){
        const getVal = (id)=> document.getElementById(id).value || '';
        document.getElementById('reviewCompany').textContent = getVal('companyName');
        document.getElementById('reviewIndustry').textContent = getVal('industry');
        document.getElementById('reviewRevenue').textContent = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(getVal('revenue')||0));
        document.getElementById('reviewEmployees').textContent = getVal('employees');
        const list = document.getElementById('reviewControls'); list.innerHTML='';
        let count=0;
        Array.from(document.querySelectorAll('#controlsContainer > div')).forEach(card=>{
          const title = card.querySelector('h4')?.textContent || '';
          const input = card.querySelector('input, select');
          let val='';
          if (input){
            if (input.type==='radio'){
              const checked = document.querySelector(`input[name="${input.name}"]:checked`);
              val = checked ? checked.value : '';
            } else if (input.tagName==='SELECT'){ val = input.value; }
            else if (input.type==='range'){ val = input.value + '%'; }
          }
          if (val){
            const badge = document.createElement('span');
            badge.className = 'ml-2 inline-flex items-center gap-1 text-[11px] px-1.5 py-0.5 rounded-full ring-1 bg-slate-50 text-slate-700 ring-slate-200';
            badge.textContent = val;
            const li=document.createElement('li');
            li.className = 'flex items-center justify-between gap-2';
            const left=document.createElement('span'); left.textContent = title; left.className='truncate';
            li.appendChild(left); li.appendChild(badge); list.appendChild(li); count++; }
        });
        reviewControlsCountEl.textContent = count;
      }

      // --- Scoring Helpers ---
      function scoreForSelect(value){
        const v = (value||'').toLowerCase();
        if (!v) return 0;
        if (['nein','nicht definiert'].includes(v)) return 0;
        if (['teilweise','basis','dokumentiert','in planung','ids'].includes(v)) return 0.5;
        return 1;
      }
      function controlScore(card){
        const input = card.querySelector('input, select');
        if (!input) return 0;
        if (input.type==='radio'){
          const checked = document.querySelector(`input[name="${input.name}"]:checked`);
          if (!checked) return 0;
          return checked.value === 'Ja' ? 1 : 0;
        }
        if (input.tagName==='SELECT'){
          return scoreForSelect(input.value);
        }
        if (input.type==='range'){
          return Number(input.value||0)/100;
        }
        return 0;
      }
      function statusForCard(card){
        const input = card.querySelector('input, select');
        if (!input) return {label:'', pct:0, tone:'neutral'};
        if (input.type==='radio'){
          const checked = document.querySelector(`input[name="${input.name}"]:checked`);
          const yes = checked && checked.value === 'Ja';
          return {label: checked ? checked.value : '—', pct: yes ? 100 : 0, tone: yes ? 'good' : 'bad'};
        }
        if (input.tagName==='SELECT'){
          const val = input.value || '—';
          const pct = Math.round(scoreForSelect(val) * 100);
          let tone = 'neutral';
          if (pct === 100) tone = 'good'; else if (pct === 0 && val !== '—') tone = 'bad';
          return {label: val, pct, tone};
        }
        if (input.type==='range'){
          const pct = Number(input.value||0);
          let tone = 'neutral';
          if (pct >= 80) tone = 'good'; else if (pct <= 20) tone = 'bad';
          return {label: pct + '%', pct, tone};
        }
        return {label:'', pct:0, tone:'neutral'};
      }
      function toneClass(t){
        if (t==='good') return 'bg-emerald-50 text-emerald-700 ring-emerald-200';
        if (t==='bad') return 'bg-rose-50 text-rose-700 ring-rose-200';
        return 'bg-slate-50 text-slate-700 ring-slate-200';
      }
      function toneDot(t){
        if (t==='good') return '✅';
        if (t==='bad') return '⛔';
        return '•';
      }

      function renderScores(){
        const groups = ['Identity & Access','Endpoint & Infrastruktur','Netzwerk & Cloud','Governance & Prozesse','Detection & Response'];
        const byGroup = Object.fromEntries(groups.map(g=>[g,{sum:0,count:0,items:[]}]))
        ;
        const cards = Array.from(document.querySelectorAll('#controlsContainer > div'));
        cards.forEach(card=>{
          const badge = card.querySelector('span.inline-flex');
          const group = badge ? badge.textContent : 'Sonstiges';
          const sc = controlScore(card);
          const st = statusForCard(card);
          if (!byGroup[group]) byGroup[group] = {sum:0,count:0,items:[]};
          byGroup[group].sum += sc; byGroup[group].count += 1;
          byGroup[group].items.push({title:card.querySelector('h4')?.textContent||'',score:sc,status:st});
        });
        const wrap = document.getElementById('scoreSummary');
        wrap.innerHTML = '';
        let overallSum = 0, overallCount = 0;
        Object.entries(byGroup).forEach(([group,data])=>{
          const pct = data.count? Math.round((data.sum/data.count)*100):0;
          overallSum += data.sum; overallCount += data.count;
          const card = document.createElement('div');
          card.className = 'p-4 rounded-xl border border-slate-200 bg-white shadow-sm';
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2"><span class="font-medium">${group}</span><span class="text-sm text-slate-600">${pct}%</span></div>
            <div class="w-full bg-slate-200 rounded-full h-2 mb-2"><div class="h-2 bg-blue-600 rounded-full" style="width:${pct}%"></div></div>
            <ul class="text-xs text-slate-600 space-y-1">
              ${data.items.slice(0,8).map(i=>`<li class=\"flex items-center justify-between gap-2\"><span class=\"truncate\">${i.title}</span><span class=\"inline-flex items-center gap-1 text-[11px] px-1.5 py-0.5 rounded-full ring-1 ${toneClass(i.status.tone)}\">${toneDot(i.status.tone)} <span>${i.status.label}</span> <span class=\"opacity-70\">(${(i.score*100)|0}%)</span></span></li>`).join('')}
            </ul>
          `;
          wrap.appendChild(card);
        });
        const overall = overallCount? Math.round((overallSum/overallCount)*100):0;
        document.getElementById('overallPct').textContent = overall + '%';
        document.getElementById('overallBar').style.width = overall + '%';
      }

      // Draft
      const LS_KEY = 'multistep-status-badges-v1';
      function saveDraft(){
        const data = new FormData(form); const obj = Object.fromEntries(data.entries());
        document.querySelectorAll('#controlsContainer input[type="radio"]').forEach(r=>{ if(r.checked) obj[r.name] = r.value; });
        document.querySelectorAll('#controlsContainer input[type="range"], #controlsContainer select').forEach(el=>{ obj[el.name] = el.value; });
        obj.current = current; localStorage.setItem(LS_KEY, JSON.stringify(obj));
        btnSaveDraft.textContent = 'Gespeichert!'; setTimeout(()=>btnSaveDraft.textContent='Zwischenspeichern', 1200);
      }
      function loadDraft(){
        try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return; const obj = JSON.parse(raw);
          ['companyName','industry','revenue','employees'].forEach(id=>{ if(obj[id]!==undefined) document.getElementById(id).value = obj[id]; });
          setTimeout(()=>{
            Object.entries(obj).forEach(([k,v])=>{
              const els = document.getElementsByName(k);
              if (!els || !els.length) return;
              const el = els[0];
              if (el.type==='radio'){
                els.forEach(r=>{ r.checked = (r.value===v); const span=r.parentElement.querySelector('.seg'); if (span){ span.classList.toggle('bg-blue-600', r.checked); span.classList.toggle('text-white', r.checked); }});
              } else { el.value = v; if (el.type==='range'){ const label = el.closest('div').querySelector('.sliderVal'); if(label) label.textContent = v; } }
            });
            updateControlsCount(); updateProgress();
          },0);
          if (typeof obj.current==='number') current = Math.min(Math.max(obj.current,0), totalSteps-1);
        }catch{}
      }

      // Events
      document.getElementById('btnPrev').addEventListener('click', ()=> showStep(Math.max(current-1,0)) );
      document.getElementById('btnNext').addEventListener('click', ()=> { if(current===0 && !validateStep1()) return; showStep(Math.min(current+1,totalSteps-1)); });
      btnSaveDraft.addEventListener('click', saveDraft);
      form.addEventListener('submit', (e)=>{ e.preventDefault(); saveDraft(); document.getElementById('success').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); });

      // Init
      renderControls();
      loadDraft();
      showStep(current);
      updateControlsCount();
      updateProgress();
    </script>
  </body>
</html>
