@* src/CMC.Web/Pages/Shared/EditDrawer.razor *@
@using System.Reflection
@using CMC.Web.Shared
@using CMC.Web.Util
@using CMC.Web.Services

<div class="ed-backdrop @(IsOpen ? "ed-backdrop--open" : "")" @onclick="Close"></div>
<div class="ed-wrap @(IsOpen ? "ed-wrap--open" : "")" role="dialog" aria-modal="true" aria-label="@_title">
	<div class="ed-header">
		<h3>@_title</h3>
		<button class="ed-icon" @onclick="Close" aria-label="Close">✕</button>
	</div>

	<div class="ed-body">
		@if (_model is not null)
		{
			<FormRenderer @ref="_form" Model="_model" IsCreate="_createMode" />
		}
	</div>

	<div class="btn-group">
		<button class="btn primary" @onclick="Save">Speichern</button>
		@if (!_createMode)
		{
			<button class="btn danger" @onclick="Delete">Löschen</button>
		}
		<button class="btn flat" @onclick="Close">Abbrechen</button>
	</div>
</div>

@code {
	private bool IsOpen;
	private string _title = "";
	private object? _model;
	private Assembly? _contractsAsm;
	private FormRenderer? _form;
	private bool _createMode = false;
	private string _action = "Update";

	private Func<RequestBuildContext, Task>? _onSave;
	private Func<RequestBuildContext, Task>? _onDelete;

	public void Open(EditDrawerRequest req)
	{
		_title = req.Title;
		_model = req.Model;
		_contractsAsm = req.ContractsAssembly;
		_onSave = req.OnSave;
		_onDelete = req.OnDelete;
		_createMode = req.IsCreate;  // Fixed: use IsCreate instead of CreateMode
		_action = string.IsNullOrWhiteSpace(req.Action) ? (_createMode ? "Register" : "Update") : req.Action;  // Fixed: use Action property
		IsOpen = true;
		StateHasChanged();
	}

	public void Close()
	{
		IsOpen = false;
		StateHasChanged();
	}

	private RequestBuildContext BuildCtx()
	{
		var changes = _form?.GetChanges() ?? new Dictionary<string, object?>();
		var provider = new CompositeValueProvider(_model!, changes);
		return new RequestBuildContext(_model!, _contractsAsm!, provider, _action);  // Pass action to context
	}

	private async Task Save()
	{
		if (_model is not null && _onSave is not null && _contractsAsm is not null)
			await _onSave.Invoke(BuildCtx()); // Aktion in OnSave selbst per Build("...") wählen
		Close();
	}

	private async Task Delete()
	{
		if (_model is not null && _onDelete is not null && _contractsAsm is not null)
			await _onDelete.Invoke(BuildCtx()); // OnDelete ruft Build("Delete")
		Close();
	}
}
