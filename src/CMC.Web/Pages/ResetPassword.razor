@page "/reset-password"
@page "/reset"
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using CMC.Web.Services
@using CMC.Application.Services
@using CMC.Contracts.Users
@using CMC.Contracts.Common
@inject UserService UserService
@inject NavigationManager Navigation
@inject ILogger<ResetPassword> Logger
@inject IBumperBus Bumper
@inject IJSRuntime JS

<PageTitle>Reset Password</PageTitle>

<canvas id="canvas" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: block;
      z-index: -1;
      pointer-events: auto;
"></canvas>
<section class="slim center">
    <div class="card">
        <h2>Reset Password</h2>

        <FormRenderer
            Model="@_vm"
            Request="@_req"
            ValueOverrides="@_overrides"
            ValidationErrors="@_errors"
            OnFieldChanged="OnFieldChanged" />

        <div class="mt-4">
            <button type="button" class="btn primary" @onclick="HandleResetPassword" disabled="@_isLoading">
                @if (_isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Resetting...</span>
                }
                else
                {
                    <span>Reset Password</span>
                }
            </button>
        </div>

        <p class="mt-4">
            <a href="/login">Back to Login</a>
        </p>
    </div>
</section>

@code {

    private bool _bgInitDone;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_bgInitDone)
        {
            try
            {
                await JS.InvokeVoidAsync("eval",
                    "window.initBgAnimation && window.initBgAnimation(document.getElementById('canvas'));");
                _bgInitDone = true;
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "BG animation init failed.");
            }
        }
    }

    // ViewModel für FormRenderer - Token wird als hidden field behandelt
    private sealed class ResetPasswordVm
    {
        [Required, Display(Name="Reset Token")]
        public string Token { get; set; } = string.Empty;

        [Required, MinLength(8), Display(Name="New Password")]
        public string NewPassword { get; set; } = string.Empty;

        [Required, Display(Name="Confirm New Password")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private readonly ResetPasswordVm _vm = new();
    private readonly Dictionary<string, object?> _overrides = new(StringComparer.OrdinalIgnoreCase);
    private readonly Dictionary<string, string[]> _errors = new(StringComparer.OrdinalIgnoreCase);
    private bool _isLoading;

    // Request für FormRenderer
    private EFEditRequest _req => new EFEditRequest
    {
        Title = "Reset Password",
        Model = _vm,
        ContractsAssembly = typeof(ResetPassword).Assembly,
        IsCreate = true
    };

    protected override void OnInitialized()
    {
        // Token aus Query String lesen
        var uri = new Uri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("token", out var token))
        {
            _vm.Token = token.ToString();
            // Token als hidden field behandeln
            _overrides["Token_InputType"] = "hidden";
        }
    }

    private void OnFieldChanged((string Name, object? Value) change)
    {
        var prop = typeof(ResetPasswordVm).GetProperty(change.Name, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        prop?.SetValue(_vm, change.Value?.ToString() ?? string.Empty);

        // Passwort-Match-Validierung
        if (change.Name.Equals("ConfirmPassword", StringComparison.OrdinalIgnoreCase) ||
            change.Name.Equals("NewPassword", StringComparison.OrdinalIgnoreCase))
        {
            ValidatePasswordMatch();
        }
    }

    private void ValidatePasswordMatch()
    {
        const string key = "ConfirmPassword";

        if (!string.IsNullOrEmpty(_vm.NewPassword) && !string.IsNullOrEmpty(_vm.ConfirmPassword))
        {
            if (_vm.NewPassword != _vm.ConfirmPassword)
            {
                _errors[key] = new[] { "Passwords do not match." };
            }
            else
            {
                _errors.Remove(key);
            }
        }
        else
        {
            _errors.Remove(key);
        }
    }

    private async Task HandleResetPassword()
    {
        try
        {
            _isLoading = true;
            _errors.Clear();

            // DataAnnotations lokal prüfen
            var ctx = new ValidationContext(_vm);
            var results = new List<ValidationResult>();
            var ok = Validator.TryValidateObject(_vm, ctx, results, validateAllProperties: true);

            // Passwort-Match zusätzlich prüfen
            ValidatePasswordMatch();

            if (!ok || _errors.Any())
            {
                foreach (var r in results)
                {
                    var key = (r.MemberNames?.FirstOrDefault()) ?? "__global";
                    if (!_errors.TryGetValue(key, out var list))
                        _errors[key] = new[] { r.ErrorMessage ?? "Invalid value." };
                    else
                        _errors[key] = list.Append(r.ErrorMessage ?? "Invalid value.").ToArray();
                }
                Bumper.Publish("Validation", "Please check your inputs.", "error");
                return;
            }

            Logger.LogInformation("Password reset attempt for token: {Token}", _vm.Token[..8] + "...");

            // ResetPasswordRequest aus ViewModel erstellen
            var resetRequest = new ResetPasswordRequest
            {
                Token = _vm.Token,
                NewPassword = _vm.NewPassword
            };

            var success = await UserService.ResetPasswordAsync(resetRequest);

            if (success)
            {
                Logger.LogInformation("Password reset successful for token: {Token}", _vm.Token[..8] + "...");
                Bumper.Publish("Password Reset", "Password reset successful! You can now login with your new password.", "success");

                // Form nach erfolgreichem Reset leeren
                _vm.Token = string.Empty;
                _vm.NewPassword = string.Empty;
                _vm.ConfirmPassword = string.Empty;

                // Nach kurzer Verzögerung zur Login-Seite weiterleiten
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                Logger.LogWarning("Password reset failed for token: {Token}", _vm.Token[..8] + "...");
                Bumper.Publish("Reset Failed", "Invalid or expired reset token.", "error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Password reset error");
            Bumper.Publish("Error", "An error occurred. Please try again.", "error");
        }
        finally
        {
            _isLoading = false;
        }
    }
}
