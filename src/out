-rw-r--r--@ 1 jonathaneberle  staff  1240 20 Aug 14:23 ./Auth/CookieEvents.cs
-rw-r--r--@ 1 jonathaneberle  staff  767 18 Aug 09:54 ./appsettings.json
-rw-r--r--@ 1 jonathaneberle  staff  557 16 Aug 00:39 ./App.razor
-rw-r--r--@ 1 jonathaneberle  staff  714 26 Aug 11:16 ./CMC.Web.csproj
-rw-r--r--@ 1 jonathaneberle  staff  301 15 Aug 15:11 ./Properties/launchSettings.json
-rw-r--r--@ 1 jonathaneberle  staff  638 21 Aug 18:34 ./_Imports.razor
-rw-r--r--@ 1 jonathaneberle  staff  4642 19 Aug 14:24 ./Controllers/AuthController.cs
-rw-r--r--@ 1 jonathaneberle  staff  19647 26 Aug 11:03 ./Pages/Shared/FormRenderer.razor
-rw-r--r--@ 1 jonathaneberle  staff  4165 26 Aug 11:10 ./Pages/Shared/EditDrawer.razor
-rw-r--r--@ 1 jonathaneberle  staff  570 21 Aug 12:24 ./Pages/Shared/ExtraField.cs
-rw-r--r--@ 1 jonathaneberle  staff  122 21 Aug 16:30 ./Pages/Shared/MainLayout.razor
-rw-r--r--@ 1 jonathaneberle  staff  391 20 Aug 23:49 ./Pages/Shared/EditStackedHost.razor
-rw-r--r--@ 1 jonathaneberle  staff  1850 18 Aug 09:54 ./Pages/Shared/ProfileMenu.razor
-rw-r--r--@ 1 jonathaneberle  staff  3425 18 Aug 21:57 ./Pages/Shared/Dialog.razor
-rw-r--r--@ 1 jonathaneberle  staff  138 18 Aug 12:35 ./Pages/Shared/RedirectToCockpit.razor
-rw-r--r--@ 1 jonathaneberle  staff  587 18 Aug 12:33 ./Pages/Shared/NavMenu.razor
-rw-r--r--@ 1 jonathaneberle  staff  1740 21 Aug 14:16 ./Pages/Shared/ChoiceDialog.razor
-rw-r--r--@ 1 jonathaneberle  staff  1067 20 Aug 22:58 ./Pages/Shared/EditHost.razor
-rw-r--r--@ 1 jonathaneberle  staff  4404 21 Aug 18:18 ./Pages/Shared/AutoTable.razor
-rw-r--r--@ 1 jonathaneberle  staff  700 18 Aug 22:08 ./Pages/Shared/MainFooter.razor
-rw-r--r--@ 1 jonathaneberle  staff  198 14 Aug 14:48 ./Pages/Shared/RedirectToLogin.razor
-rw-r--r--@ 1 jonathaneberle  staff  9824 26 Aug 11:10 ./Pages/Shared/EditContextAdapter.cs
-rw-r--r--@ 1 jonathaneberle  staff  2405 21 Aug 16:11 ./Pages/Shared/DialogHost.razor
-rw-r--r--@ 1 jonathaneberle  staff  12522 18 Aug 12:33 ./Pages/Index.razor
-rw-r--r--@ 1 jonathaneberle  staff  229 15 Aug 15:11 ./Pages/Logout.razor
-rw-r--r--@ 1 jonathaneberle  staff  3451 18 Aug 09:54 ./Pages/Login.razor
-rw-r--r--@ 1 jonathaneberle  staff  2130 18 Aug 09:54 ./Pages/ForgotPassword.razor
-rw-r--r--@ 1 jonathaneberle  staff  91 18 Aug 13:34 ./Pages/CockpitPages/CockpitOverview.razor
-rw-r--r--@ 1 jonathaneberle  staff  91 18 Aug 13:34 ./Pages/CockpitPages/CockpitScenarios.razor
-rw-r--r--@ 1 jonathaneberle  staff  4344 26 Aug 10:30 ./Pages/CockpitPages/CockpitCustomers.razor
-rw-r--r--@ 1 jonathaneberle  staff  3473 26 Aug 10:33 ./Pages/CockpitPages/CockpitUsers.razor
-rw-r--r--@ 1 jonathaneberle  staff  1600 18 Aug 12:33 ./Pages/_Host.cshtml
-rw-r--r--@ 1 jonathaneberle  staff  1684 18 Aug 09:54 ./Pages/Profile.razor
-rw-r--r--@ 1 jonathaneberle  staff  4136 18 Aug 09:54 ./Pages/ResetPassword.razor
-rw-r--r--@ 1 jonathaneberle  staff  4427 18 Aug 09:54 ./Pages/Register.razor
-rw-r--r--@ 1 jonathaneberle  staff  6420 20 Aug 21:55 ./Pages/Cockpit.razor
-rw-r--r--@ 1 jonathaneberle  staff  883 18 Aug 09:54 ./appsettings.Production.json
-rw-r--r--@ 1 jonathaneberle  staff  2379 21 Aug 12:47 ./Services/RelationDialogService.cs
-rw-r--r--@ 1 jonathaneberle  staff  8894 21 Aug 18:22 ./Services/Relations.cs
-rw-r--r--@ 1 jonathaneberle  staff  1891 21 Aug 12:24 ./Services/EditDrawerService.cs
-rw-r--r--@ 1 jonathaneberle  staff  14306 21 Aug 14:00 ./Services/EntityManager.cs
-rw-r--r--@ 1 jonathaneberle  staff  2068 21 Aug 14:16 ./Services/DialogServiceExtensions.cs
-rw-r--r--@ 1 jonathaneberle  staff  1230 21 Aug 12:45 ./Services/DialogService.cs
-rw-r--r--@ 1 jonathaneberle  staff  4474 26 Aug 10:39 ./Program.cs
=== FILE CONTENTS ===
=== ./Auth/CookieEvents.cs ===
// src/CMC.Web/Auth/CookieEvents.cs
using System;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication.Cookies;

namespace CMC.Web.Auth;

public sealed class CookieEvents : CookieAuthenticationEvents
{
    public override Task SigningIn(CookieSigningInContext context)
    {
        context.Properties.IsPersistent = true;
        context.Properties.ExpiresUtc = DateTimeOffset.UtcNow.AddDays(30);
        Console.WriteLine("üîê User signing in: " + context.Principal?.Identity?.Name);
        return Task.CompletedTask;
    }

    public override Task SignedIn(CookieSignedInContext context)
    {
        Console.WriteLine("‚úÖ User signed in: " + context.Principal?.Identity?.Name);
        return Task.CompletedTask;
    }

    public override Task ValidatePrincipal(CookieValidatePrincipalContext context)
    {
        Console.WriteLine("üîç Validate principal: " + context.Principal?.Identity?.Name);
        if (context.Principal?.Identity?.IsAuthenticated != true)
        {
            Console.WriteLine("‚ùå Principal invalid");
            context.RejectPrincipal();
        }
        else
        {
            Console.WriteLine("‚úÖ Principal valid");
        }
        return Task.CompletedTask;
    }
}
=== ./appsettings.json ===
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=cmc_dev;Username=postgres;Password=password;Port=5432"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Information"
    },
    "Console": {
      "IncludeScopes": false,
      "LogLevel": {
        "Default": "Information"
      }
    }
  },
  "AllowedHosts": "*",
  "DetailedErrors": true,
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://localhost:5000"
      },
      "Https": {
        "Url": "https://localhost:5001"
      }
    }
  },
  "Security": {
    "RequireHttpsMetadata": false,
    "CookieSecure": false,
    "UseHsts": false
  }
}
=== ./App.razor ===
<CascadingAuthenticationState>
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(Pages.Shared.MainLayout)" />
        </Found>
        <NotFound>
            <PageTitle>Not found</PageTitle>
            <LayoutView Layout="@typeof(Pages.Shared.MainLayout)">
                <h1>Page Not Found</h1>
                <p>Sorry, there's nothing at this address.</p>
            </LayoutView>
        </NotFound>
    </Router>
</CascadingAuthenticationState>
=== ./CMC.Web.csproj ===
<Project Sdk="Microsoft.NET.Sdk.Web">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
	  <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
    <ProjectReference Include="..\CMC.Application\CMC.Application.csproj"/>
    <ProjectReference Include="..\CMC.Infrastructure\CMC.Infrastructure.csproj"/>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.10"/>
		<PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.*" />
		<PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="8.*" />
  </ItemGroup>
</Project>
=== ./Properties/launchSettings.json ===
{
  "profiles": {
    "CMC.Web": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "http://localhost:5000;https://localhost:5001",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
=== ./_Imports.razor ===
@using System.Net.Http
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using CMC.Web
@using CMC.Web.Pages.Shared
@using CMC.Application.Services
@using CMC.Contracts.Users
@using CMC.Domain.Common
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using CMC.Web.Services
@using CMC.Contracts.Common   <!-- ‚ú® NEU: Attribute f√ºr Editorsteuerung -->
=== ./Controllers/AuthController.cs ===
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;
using CMC.Application.Services;
using CMC.Contracts.Users;

namespace CMC.Web.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly UserService _userService;
        private readonly ILogger<AuthController> _logger;

        public AuthController(UserService userService, ILogger<AuthController> logger)
        {
            _userService = userService;
            _logger = logger;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequest request)
        {
            try
            {
                _logger.LogInformation("üîê API Login attempt for: {Email}", request.Email);

                var user = await _userService.LoginAsync(request);
                if (user is null)
                {
                    _logger.LogWarning("‚ùå API Login failed for: {Email}", request.Email);
                    return Unauthorized(new { message = "Invalid email or password" });
                }

                await SetAuthenticationCookie(user);

                _logger.LogInformation("‚úÖ API Login successful for: {Email}", request.Email);
                return Ok(new { message = "Login successful", user });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå API Login error for: {Email}", request.Email);
                return StatusCode(500, new { message = "An error occurred during login" });
            }
        }

        [HttpPost("logout")]
        [HttpGet("logout")]
        public async Task<IActionResult> Logout()
        {
            try
            {
                await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
                _logger.LogInformation("‚úÖ API Logout successful");
                return Redirect("/login");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå API Logout error");
                return StatusCode(500, new { message = "Logout failed" });
            }
        }

        [HttpGet("user")]
        [Authorize]
        public async Task<IActionResult> GetCurrentUser()
        {
            try
            {
                if (HttpContext.User.Identity?.IsAuthenticated == true)
                {
                    var userIdClaim = HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                    if (Guid.TryParse(userIdClaim, out var userId))
                    {
                        var user = await _userService.GetByIdAsync(userId);
                        if (user is null) return NotFound();
                        return Ok(user); // user ist bereits ein UserDto in deinem Service-Design
                    }
                }
                return Unauthorized();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting current user");
                return StatusCode(500);
            }
        }

        private async Task SetAuthenticationCookie(UserDto user)
        {
            try
            {
                var claims = new List<Claim>
                {
                    new(ClaimTypes.NameIdentifier, user.Id.ToString()),
                    new(ClaimTypes.Name, user.Email),
                    new(ClaimTypes.Email, user.Email),
                    new(ClaimTypes.GivenName, user.FirstName ?? string.Empty),
                    new(ClaimTypes.Surname, user.LastName ?? string.Empty)
                };

                var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                var authProps = new AuthenticationProperties
                {
                    IsPersistent = true,
                    ExpiresUtc = DateTimeOffset.UtcNow.AddDays(30),
                    AllowRefresh = true
                };

                await HttpContext.SignInAsync(
                    CookieAuthenticationDefaults.AuthenticationScheme,
                    new ClaimsPrincipal(identity),
                    authProps
                );

                _logger.LogInformation("‚úÖ Authentication cookie set for: {Email}", user.Email);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå Error setting authentication cookie");
                throw;
            }
        }
    }
}
=== ./Pages/Shared/FormRenderer.razor ===
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using CMC.Web.Shared
@using CMC.Web.Pages.Shared
@using CMC.Web.Services
@using CMC.Contracts.Common

@inject IRelationshipManager Rels
@inject DialogService Dialogs

<div class="form-grid">
	@if (Model is not null)
	{
		@foreach (var prop in VisibleProps)
		{
			var pType = EffectiveType(prop.PropertyType);
			var label = GetDisplayName(prop) ?? prop.Name;
			var current = prop.GetValue(Model);

			<div class="form-row">
				<label class="form-label">@label</label>

				@if (TryGetSelectOptions(prop, out var selectOpts))
				{
					var value = current?.ToString() ?? string.Empty;
					<select class="form-control" @onchange="e => OnChanged(prop.Name, e.Value?.ToString())">
						<option value="">-- bitte w√§hlen --</option>
						@foreach (var opt in selectOpts)
						{
							var selected = string.Equals(opt.Value, value, StringComparison.OrdinalIgnoreCase);
							<option value="@opt.Value" selected="@selected">@opt.Key</option>
						}
					</select>
				}
				else
				{
					var relAttr = prop.GetCustomAttribute<RelationFromAttribute>();
					if (relAttr is not null && Request.EfParentType is not null && Request.ContractsAssembly is not null)
					{
						var uiKey = $"prop::{prop.Name}";
						var relationName = string.IsNullOrWhiteSpace(relAttr.RelationName)
							? DeriveRelationName(prop.Name)
							: relAttr.RelationName;

						EnsureRelationLoaded(uiKey, relationName);

						if (_relLoading.Contains(uiKey))
						{
							<input class="form-control" type="text" value="Lade Optionen ‚Ä¶" disabled />
						}
						else if (_relKind.TryGetValue(uiKey, out var kind) && _relOptions.TryGetValue(uiKey, out var opts))
						{
							if (!relAttr.IsMany && kind == RelationKind.Reference)
							{
								if (!_relSingle.ContainsKey(uiKey))
									_relSingle[uiKey] = current?.ToString();

								var cur = _relSingle[uiKey] ?? string.Empty;
								<select class="form-control" @onchange="e => SetRelationSingle(prop.Name, e.Value?.ToString())">
									<option value="">-- bitte w√§hlen --</option>
									@foreach (var o in opts)
									{
										var sel = string.Equals(o.Value, cur, StringComparison.OrdinalIgnoreCase);
										<option value="@o.Value" selected="@sel">@o.Key</option>
									}
								</select>
							}
							else if (relAttr.IsMany && kind == RelationKind.ManyToMany)
							{
								var key = prop.Name;
								if (!_relMany.ContainsKey(key))
								{
									var lst = new List<string>();
									if (current is IEnumerable<string> es) lst = es.ToList();
									else if (current is string s && !string.IsNullOrWhiteSpace(s))
										lst = s.Split(',').Select(x => x.Trim()).Where(x => x.Length > 0).ToList();
									_relMany[key] = lst;
								}

								@RenderCheckboxList(key, opts)
							}
							else
							{
								<input class="form-control" type="text" value="(Relation nicht verf√ºgbar)" disabled />
							}
						}
						else
						{
							<input class="form-control" type="text" value="(Relation nicht verf√ºgbar)" disabled />
						}
					}
					else
					{
						@switch (TypeCodeOf(pType))
						{
							case TypeCode.Boolean:
							{
								var chk = current as bool? ?? false;
								<input type="checkbox" checked="@chk" @onchange="e => OnBooleanChanged(prop.Name, e)" />
								break;
							}
							case TypeCode.DateTime:
							{
								var dt = current as DateTime? ?? default;
								var val = dt == default ? "" : ToDateTimeLocalValue(dt);
								<input class="form-control" type="datetime-local" value="@val" @oninput="e => OnChanged(prop.Name, ParseDateTimeLocal(e.Value?.ToString()))" />
								break;
							}
							case TypeCode.Decimal:
							{
								var dec = current as decimal? ?? 0m;
								<input class="form-control" type="number" step="any" value="@dec" @oninput="e => OnChanged(prop.Name, ParseDecimal(e.Value?.ToString()))" />
								break;
							}
							case TypeCode.Double:
							case TypeCode.Single:
							{
								var dbl = current is double d ? d : current is float f ? (double)f : 0d;
								<input class="form-control" type="number" step="any" value="@dbl" @oninput="e => OnChanged(prop.Name, ParseDouble(e.Value?.ToString()))" />
								break;
							}
							case TypeCode.Int16:
							case TypeCode.Int32:
							case TypeCode.Int64:
							case TypeCode.UInt16:
							case TypeCode.UInt32:
							case TypeCode.UInt64:
							{
								var num = current?.ToString() ?? "0";
								<input class="form-control" type="number" step="1" value="@num" @oninput="e => OnChanged(prop.Name, ParseLongOrInt(pType, e.Value?.ToString()))" />
								break;
							}
							case TypeCode.String:
							{
								var txt = current?.ToString() ?? string.Empty;
								var isPw = prop.Name.Contains("Password", StringComparison.OrdinalIgnoreCase);
								<input class="form-control" type="@(isPw ? "password" : "text")" autocomplete="@(isPw ? "new-password" : null)" value="@txt" @oninput="e => OnChanged(prop.Name, e.Value?.ToString())" />
								break;
							}
							default:
							{
								if (pType == typeof(Guid))
								{
									var gtxt = current?.ToString() ?? string.Empty;
									<input class="form-control" type="text" value="@gtxt" disabled />
								}
								else
								{
									var raw = current?.ToString() ?? string.Empty;
									<input class="form-control" type="text" value="@raw" @oninput="e => OnChanged(prop.Name, e.Value?.ToString())" />
								}
								break;
							}
						}
					}
				}
			</div>
		}
	}

	@if (ExtraFields?.Count > 0)
	{
		@foreach (var ef in ExtraFields)
		{
			var label = string.IsNullOrWhiteSpace(ef.Label) ? ef.Name : ef.Label;
			var hint = ef.Hint;

			<div class="form-row">
				<label class="form-label">@label</label>

				@if (string.Equals(ef.DataType, "relation-auto", StringComparison.OrdinalIgnoreCase))
				{
					var relationName = DeriveRelationName(ef.Name);

					if (Request.EfParentType is null || Request.ContractsAssembly is null)
					{
						<input class="form-control" type="text" value="(Relation nicht konfiguriert)" disabled />
					}
					else
					{
						EnsureRelationLoaded(ef.Name, relationName);

						if (_relLoading.Contains(ef.Name))
						{
							<input class="form-control" type="text" value="Lade Optionen ‚Ä¶" disabled />
						}
						else if (_relKind.TryGetValue(ef.Name, out var kind) && _relOptions.TryGetValue(ef.Name, out var opts))
						{
							if (kind == RelationKind.Reference)
							{
								if (!_relSingle.ContainsKey(ef.Name))
									_relSingle[ef.Name] = ef.Value?.ToString();

								var current = _relSingle[ef.Name] ?? string.Empty;
								<select class="form-control" @onchange="e => SetRelationSingle(ef.Name, e.Value?.ToString())">
									<option value="">-- bitte w√§hlen --</option>
									@foreach (var o in opts)
									{
										var sel = string.Equals(o.Value, current, StringComparison.OrdinalIgnoreCase);
										<option value="@o.Value" selected="@sel">@o.Key</option>
									}
								</select>
							}
							else if (kind == RelationKind.ManyToMany)
							{
								if (!_relMany.ContainsKey(ef.Name))
								{
									var lst = new List<string>();
									if (ef.Value is IEnumerable<string> es) lst = es.ToList();
									else if (ef.Value is string s && !string.IsNullOrWhiteSpace(s))
										lst = s.Split(',').Select(x => x.Trim()).Where(x => x.Length > 0).ToList();
									_relMany[ef.Name] = lst;
								}

								@RenderCheckboxList(ef.Name, opts)
							}
							else
							{
								<input class="form-control" type="text" value="(Relationstyp nicht unterst√ºtzt)" disabled />
							}
						}
						else
						{
							<input class="form-control" type="text" value="(Keine Optionen gefunden)" disabled />
						}
					}
				}
				else if (string.Equals(ef.DataType, "password", StringComparison.OrdinalIgnoreCase))
				{
					var txt = ef.Value?.ToString() ?? string.Empty;
					<input class="form-control" type="password" autocomplete="new-password" value="@txt" @oninput="e => OnChanged(ef.Name, e.Value?.ToString())" />
				}
				else if (ef.Options != null && ef.Options.Any())
				{
					var current = ef.Value?.ToString() ?? string.Empty;
					var isDisabled = ef.ReadOnly;

					<select class="form-control" disabled="@isDisabled" @onchange="e => OnChanged(ef.Name, e.Value?.ToString())">
						<option value="">-- bitte w√§hlen --</option>
						@foreach (var opt in ef.Options)
						{
							var selected = string.Equals(opt.Value, current, StringComparison.OrdinalIgnoreCase);
							<option value="@opt.Value" selected="@selected">@opt.Key</option>
						}
					</select>
				}
				else
				{
					var txt = ef.Value?.ToString() ?? string.Empty;
					if (ef.ReadOnly)
					{
						<input class="form-control" type="text" value="@txt" disabled />
					}
					else
					{
						<input class="form-control" type="text" value="@txt" @oninput="e => OnChanged(ef.Name, e.Value?.ToString())" />
					}
				}

				@if (!string.IsNullOrWhiteSpace(hint))
				{
					<div class="form-hint">@hint</div>
				}
			</div>
		}
	}
</div>

@code {

	[Parameter, EditorRequired] public object Model { get; set; } = default!;
	[Parameter] public List<ExtraField> ExtraFields { get; set; } = new();
	[Parameter] public EventCallback<(string Name, object? Value)> OnFieldChanged { get; set; }
	[Parameter] public EditDrawerRequest Request { get; set; } = default!;
	[Parameter] public EditContextAdapter Ctx { get; set; } = default!;

	// --- Relation-Cache/State ---
	private readonly Dictionary<string, RelationKind> _relKind = new(StringComparer.OrdinalIgnoreCase);
	private readonly Dictionary<string, List<KeyValuePair<string,string>>> _relOptions = new(StringComparer.OrdinalIgnoreCase);
	private readonly HashSet<string> _relLoading = new(StringComparer.OrdinalIgnoreCase);

	private readonly Dictionary<string, string?> _relSingle = new(StringComparer.OrdinalIgnoreCase);
	private readonly Dictionary<string, List<string>> _relMany = new(StringComparer.OrdinalIgnoreCase);

	private IEnumerable<PropertyInfo> VisibleProps => GetVisibleProps();

	private IEnumerable<PropertyInfo> GetVisibleProps()
	{
		if (Model is null) yield break;

		var type = Model.GetType();
		var allProps = type.GetProperties(BindingFlags.Public | BindingFlags.Instance)
						   .Where(p => p.CanRead)
						   .ToList();

		var propNames = new HashSet<string>(allProps.Select(p => p.Name), StringComparer.OrdinalIgnoreCase);
		var extraNames = new HashSet<string>((ExtraFields ?? new()).Select(ef => ef.Name), StringComparer.OrdinalIgnoreCase);

		foreach (var p in allProps)
		{
			var scaffold = p.GetCustomAttribute<ScaffoldColumnAttribute>();
			if (scaffold is { Scaffold: false }) continue;

			var disp = p.GetCustomAttribute<DisplayAttribute>();
			if (disp?.GetAutoGenerateField() == false) continue;

			if (p.GetCustomAttribute<EditorHiddenAttribute>() is not null)
				continue;

			var hideIfs = p.GetCustomAttributes<EditorHideIfExistsAttribute>()?.ToList();
			if (hideIfs is { Count: > 0 } &&
				hideIfs.Any(h => propNames.Contains(h.OtherProperty) || extraNames.Contains(h.OtherProperty)))
				continue;

			if ((hideIfs is null || hideIfs.Count == 0) &&
				p.PropertyType == typeof(string) &&
				p.Name.EndsWith("Name", StringComparison.OrdinalIgnoreCase))
			{
				var root = p.Name[..^"Name".Length];
				if (propNames.Contains(root + "Id") || extraNames.Contains(root + "Id"))
					continue;
			}

			yield return p;
		}
	}

	private bool TryGetSelectOptions(PropertyInfo p, out List<KeyValuePair<string,string>> options)
	{
		options = new();
		var attr = p.GetCustomAttribute<SelectFromAttribute>();
		if (attr is null) return false;

		try
		{
			var path = attr.SourcePath?.Trim() ?? string.Empty;
			var lastDot = path.LastIndexOf('.');
			if (lastDot <= 0 || lastDot >= path.Length - 1) return false;

			var typeName = path[..lastDot];
			var member = path[(lastDot + 1)..];

			// robuste Typaufl√∂sung (erst: Assembly der Property; dann: ContractsAssembly; dann: alle Assemblies)
			var sourceType = TryResolveType(typeName, p.DeclaringType?.Assembly);
			if (sourceType is null) return false;

			var flags = BindingFlags.Public | BindingFlags.Static | BindingFlags.FlattenHierarchy;
			var field = sourceType.GetField(member, flags);
			var prop = sourceType.GetProperty(member, flags);

			object? raw = field?.GetValue(null) ?? prop?.GetValue(null);
			if (raw is null) return false;

			options = ToOptions(raw);
			return options.Count > 0;
		}
		catch
		{
			return false;
		}
	}

	private Type? TryResolveType(string typeName, Assembly? contextAsm)
	{
		Type? t = null;

		// 0) Zuerst die Assembly der Property selbst
		if (contextAsm != null)
		{
			try { t = contextAsm.GetType(typeName, throwOnError: false, ignoreCase: false); } catch { }
			if (t != null) return t;
		}

		// 1) Dann die mitgegebene Contracts-Assembly
		if (Request?.ContractsAssembly != null)
		{
			try { t = Request.ContractsAssembly.GetType(typeName, throwOnError: false, ignoreCase: false); } catch { }
			if (t != null) return t;
		}

		// 2) Alle geladenen Assemblies scannen
		foreach (var asm in AppDomain.CurrentDomain.GetAssemblies())
		{
			try
			{
				t = asm.GetType(typeName, throwOnError: false, ignoreCase: false);
				if (t != null) return t;
			}
			catch { }
		}

		// 3) Fallback: assembly-qualified konstruieren (Contracts-Assemblyname)
		var asmName = Request?.ContractsAssembly?.GetName().Name ?? contextAsm?.GetName().Name;
		if (!string.IsNullOrWhiteSpace(asmName))
		{
			try { t = Type.GetType($"{typeName}, {asmName}", throwOnError: false); } catch { }
			if (t != null) return t;
		}

		return null;
	}

	private static List<KeyValuePair<string,string>> ToOptions(object? raw)
	{
		var result = new List<KeyValuePair<string,string>>();
		if (raw is not System.Collections.IEnumerable seq) return result;

		foreach (var item in seq)
		{
			if (item is KeyValuePair<string,string> kv)
			{
				result.Add(kv);
				continue;
			}

			var t = item.GetType();

			var labelProp = t.GetProperty("Label") ?? t.GetProperty("Name") ?? t.GetProperty("Text") ?? t.GetProperty("Key");
			var valueProp = t.GetProperty("Tag")   ?? t.GetProperty("Value") ?? t.GetProperty("Id")  ?? t.GetProperty("Key");

			if (labelProp is null && valueProp is null)
			{
				labelProp = t.GetProperty("Item1");
				valueProp = t.GetProperty("Item2");
			}

			var label = labelProp?.GetValue(item)?.ToString();
			var value = valueProp?.GetValue(item)?.ToString();

			label ??= item.ToString() ?? "";
			value ??= label;

			if (!string.IsNullOrWhiteSpace(value))
				result.Add(new KeyValuePair<string,string>(label, value));
		}

		return result;
	}

	private void EnsureRelationLoaded(string uiKey, string relationName)
	{
		if (_relOptions.ContainsKey(uiKey) || _relLoading.Contains(uiKey))
			return;

		if (Request.EfParentType is null)
		{
			_relOptions[uiKey] = new();
			return;
		}

		_relLoading.Add(uiKey);

		try
		{
			var desc = Rels.GetDescriptor(Request.EfParentType, relationName);
			_relKind[uiKey] = desc.Kind;

			_ = Task.Run(async () =>
			{
				try
				{
					var all = await desc.LoadOptions(); // (Label, Value)
					var opts = all.Select(o => new KeyValuePair<string,string>(o.Label, o.Value)).ToList();
					_relOptions[uiKey] = opts;
				}
				catch
				{
					_relOptions[uiKey] = new();
				}
				finally
				{
					_relLoading.Remove(uiKey);
					await InvokeAsync(StateHasChanged);
				}
			});
		}
		catch
		{
			_relOptions[uiKey] = new();
			_relLoading.Remove(uiKey);
		}
	}

	private RenderFragment RenderCheckboxList(string name, IEnumerable<KeyValuePair<string,string>> options) => builder =>
	{
		var seq = 0;
		var selected = _relMany.TryGetValue(name, out var lst) ? lst : new List<string>();

		foreach (var opt in options)
		{
			var isChecked = selected.Contains(opt.Value, StringComparer.OrdinalIgnoreCase);

			// Open label element
			builder.OpenElement(seq++, "label");
			builder.AddAttribute(seq++, "class", "chk-inline");

			// Open input element
			builder.OpenElement(seq++, "input");
			builder.AddAttribute(seq++, "type", "checkbox");
			builder.AddAttribute(seq++, "checked", isChecked);
			builder.AddAttribute(seq++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, async e =>
			{
				var cur = _relMany.TryGetValue(name, out var existing) ? existing : new List<string>();
				var nowChecked = e.Value?.ToString() == "on" || (e.Value is bool b && b);

				if (nowChecked)
				{
					if (!cur.Contains(opt.Value)) cur.Add(opt.Value);
				}
				else
				{
					cur = cur.Where(v => !string.Equals(v, opt.Value, StringComparison.OrdinalIgnoreCase)).ToList();
				}
				_relMany[name] = cur;
				await OnChanged(name, cur);
			}));
			// Close input element
			builder.CloseElement();

			// Add label text content
			builder.AddContent(seq++, $" {opt.Key}");

			// Close label element
			builder.CloseElement();
		}
	};

	private async Task SetRelationSingle(string name, string? value)
	{
		_relSingle[name] = value;
		await OnChanged(name, value);
	}

	private static string? GetDisplayName(PropertyInfo p)
		=> p.GetCustomAttribute<DisplayAttribute>()?.GetName();

	private static Type EffectiveType(Type t) => Nullable.GetUnderlyingType(t) ?? t;

	private static TypeCode TypeCodeOf(Type t)
	{
		var et = EffectiveType(t);
		return Type.GetTypeCode(et);
	}

	private static string ToDateTimeLocalValue(DateTime dt)
	{
		var local = dt.Kind == DateTimeKind.Utc ? dt.ToLocalTime() : dt;
		return local.ToString("yyyy-MM-ddTHH:mm");
	}

	private static DateTime? ParseDateTimeLocal(string? s)
		=> DateTime.TryParse(s, out var dt) ? dt : null;

	private static decimal? ParseDecimal(string? s)
		=> decimal.TryParse(s, System.Globalization.NumberStyles.Any,
							System.Globalization.CultureInfo.InvariantCulture, out var v) ? v : null;

	private static double? ParseDouble(string? s)
		=> double.TryParse(s, System.Globalization.NumberStyles.Any,
						   System.Globalization.CultureInfo.InvariantCulture, out var v) ? v : null;

	private static object? ParseLongOrInt(Type numberType, string? s)
	{
		if (!long.TryParse(s, out var l)) return null;

		var et = EffectiveType(numberType);
		if (et == typeof(int)) return (int)l;
		if (et == typeof(long)) return l;
		if (et == typeof(short)) return (short)l;
		if (et == typeof(uint)) return (uint)Math.Max(0, l);
		if (et == typeof(ulong)) return (ulong)Math.Max(0, l);
		if (et == typeof(ushort)) return (ushort)Math.Max(0, l);

		return l;
	}

	private async Task OnChanged(string name, object? value)
	{
		if (OnFieldChanged.HasDelegate)
			await OnFieldChanged.InvokeAsync((name, value));
	}

	private async Task OnBooleanChanged(string name, ChangeEventArgs e)
	{
		bool? value = null;

		if (e.Value is bool boolValue) value = boolValue;
		else if (e.Value?.ToString() == "on") value = true;
		else if (bool.TryParse(e.Value?.ToString(), out var parsedBool)) value = parsedBool;

		await OnChanged(name, value);
	}

	private static string DeriveRelationName(string fieldName)
	{
		if (fieldName.EndsWith("Id", StringComparison.Ordinal))
			return fieldName.Substring(0, fieldName.Length - 2);

		if (fieldName.EndsWith("Ids", StringComparison.Ordinal))
			return fieldName.Substring(0, fieldName.Length - 3);

		return fieldName;
	}

	private void ShowConfigError(string msg)
		=> Dialogs.Open(new DialogRequest { Title = "Konfiguration", Message = msg, OnConfirm = () => Task.CompletedTask });
}
=== ./Pages/Shared/EditDrawer.razor ===
@using System.Reflection
@using Microsoft.AspNetCore.Components
@using CMC.Web.Services
@using CMC.Web.Shared
@implements IDisposable
@inject EditDrawerService EditDrawerService

@if (_isOpen && _request is not null)
{
	<!-- Backdrop -->
	<div class="ed-backdrop ed-backdrop--open" style="z-index:@ZIndex" aria-hidden="true"></div>

	<!-- Panel -->
	<aside class="ed-wrap ed-wrap--open" style="z-index:@(ZIndex+1)" role="dialog" aria-modal="true" aria-labelledby="ed-title" @onclick:stopPropagation>
		<header class="ed-header">
			<h3 id="ed-title">@_request.Title</h3>
			<button class="btn flat" @onclick="Cancel" aria-label="Schlie√üen">√ó</button>
		</header>

		<section class="ed-body">
			<FormRenderer @ref="_form"
						  Model="_request.Model"
						  Request="_request"
						  Ctx="_adapter"
						  ExtraFields="_request.ExtraFields"
						  OnFieldChanged="OnFieldChanged" />
		</section>

<footer class="ed-body" style="border-top:1px solid #eee; padding-top:.5rem;">
  <div class="btn-group">
    <button type="button" class="btn primary" @onclick="SaveAsync">Speichern</button>
    @if (_request.OnDelete is not null && !_request.IsCreate)
    {
      <button type="button" class="btn danger" @onclick="DeleteAsync">L√∂schen</button>
    }
    <button type="button" class="btn flat" @onclick="Cancel">Abbrechen</button>
  </div>
</footer>

	</aside>
}

@code {
	[Parameter] public int ZIndex { get; set; } = 1000;

	// --- Parameter-Modus (Stacked) ---
	[Parameter] public EditDrawerRequest? Request { get; set; }
	private bool _openedByParameter;
	private bool _useServiceEvents;

	protected override void OnInitialized()
	{
	}

	protected override void OnParametersSet()
	{
		var wantServiceMode = Request is null;

		if (wantServiceMode && !_useServiceEvents)
		{
			EditDrawerService.OpenRequested += HandleOpen;
			EditDrawerService.CloseRequested += HandleClose;
			_useServiceEvents = true;
		}
		else if (!wantServiceMode && _useServiceEvents)
		{
			EditDrawerService.OpenRequested -= HandleOpen;
			EditDrawerService.CloseRequested -= HandleClose;
			_useServiceEvents = false;
		}

		if (Request is not null && !ReferenceEquals(Request, _request))
		{
			HandleOpen(Request);
			_openedByParameter = true;
		}
		else if (Request is null && _openedByParameter)
		{
			HandleClose();
			_openedByParameter = false;
		}
	}


	// --- State ---
	private bool _isOpen;
	private EditDrawerRequest? _request;
	private FormRenderer? _form;

	// Neues Build/Mapping-Objekt (ersetzt RequestBuildContext)
	private EditContextAdapter? _adapter;

	// √Ñnderungen, die der FormRenderer via OnFieldChanged meldet (werden in Adapter gemappt)
	private readonly Dictionary<string, object?> _changes = new(StringComparer.OrdinalIgnoreCase);

	private void HandleOpen(EditDrawerRequest req)
	{
		Console.WriteLine($"EditDrawer: OPEN -> {req.Title}");
		_request = req;
		_changes.Clear();

		// Adapter inkl. Overrides (damit ExtraFields/OnFieldChanged in Build(...) landen)
		_adapter = new EditContextAdapter(req, req.Model, _changes);

		_isOpen = true;
		StateHasChanged();
	}

	private void HandleClose()
	{
		Console.WriteLine("EditDrawer: CLOSE");
		_isOpen = false;
		_request = null;
		_adapter = null;
		_changes.Clear();
		StateHasChanged();
	}

	private void OnFieldChanged((string Name, object? Value) change) => _changes[change.Name] = change.Value;

	private async Task SaveAsync()
	{
		if (_request is null) return;

		// Adapter frisch mit *aktuellen* √Ñnderungen bauen
		_adapter = new EditContextAdapter(_request, _request.Model, _changes);

		if (_request.OnSave is not null)
			await _request.OnSave.Invoke(_adapter);
	}

	private async Task DeleteAsync()
	{
		_changes.Clear();
		if (_request?.OnDelete is not null && _adapter is not null)
			await _request.OnDelete.Invoke(_adapter);
		// OnDelete entscheidet i. d. R. selbst √ºber Close (z. B. nach Confirm)
	}

	private void Cancel()
	{
		// Immer nur den obersten Drawer schlie√üen
		EditDrawerService.Close();
	}

	public void Dispose()
	{
		if (_useServiceEvents)
		{
			EditDrawerService.OpenRequested -= HandleOpen;
			EditDrawerService.CloseRequested -= HandleClose;
		}
	}
}
=== ./Pages/Shared/ExtraField.cs ===
namespace CMC.Web.Shared;

/// <summary>
/// Beschreibt ein zus√§tzliches Formularfeld (z.B. Relation-Picker oder Passwort),
/// das nicht direkt aus dem DTO gerendert wird.
/// </summary>
public sealed record ExtraField(
	string Name,
	string Label,
	Type Type,
	bool ReadOnly = false,
	string? Hint = null,
	string DataType = "text",
	object? Value = null,
	List<KeyValuePair<string,string>>? Options = null,
	Func<Task<KeyValuePair<string,string>?>>? OnCreateNew = null,
	Func<string, Task<List<KeyValuePair<string,string>>>>? OnSearch = null,
	int DebounceMs = 0
);
=== ./Pages/Shared/MainLayout.razor ===
@inherits LayoutComponentBase

<NavMenu />
<main>
    @Body
<EditStackedHost />
    <DialogHost />
</main>
<MainFooter />
=== ./Pages/Shared/EditStackedHost.razor ===
@using CMC.Web.Services
@inject EditDrawerService Service
@implements IDisposable

@code {
	protected override void OnInitialized()
	{
		Service.StackChanged += StateHasChanged;
	}

	public void Dispose()
	{
		Service.StackChanged -= StateHasChanged;
	}
}

@for (var i = 0; i < Service.Stack.Count; i++)
{
	var req = Service.Stack[i];
	<EditDrawer Request="@req" ZIndex="@(1000 + i*2)" />
}
=== ./Pages/Shared/ProfileMenu.razor ===
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation

<AuthorizeView>
	<Authorized>
		<div class="relative inline-block text-left">
			<button class="profile-card flex items-center gap-2 px-3 py-2"
					@onclick="ToggleMenu"
					aria-haspopup="true"
					aria-expanded="@showMenu">
				@GetFullName(context)
				<span class="text-xs">‚ñæ</span>
			</button>

			@if (showMenu)
			{
				<div class="absolute right-0 mt-2 w-44 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black/5 z-50"
					 @onfocusout="HideMenu"
					 tabindex="-1">
					<ul class="py-1">
						<li>
							<NavLink href="profile" class="block px-4 py-2 text-sm hover:bg-gray-100">
								Profile
							</NavLink>
						</li>
						<li>
							<NavLink href="logout" class="block px-4 py-2 text-sm hover:bg-gray-100">
								Logout
							</NavLink>
						</li>
					</ul>
				</div>
			}
		</div>
	</Authorized>
	<NotAuthorized>
		<nav class="profile-nav">
			<ul>
				<NavLink href="login" Match="NavLinkMatch.All">
					<span aria-hidden="true"></span> Login
				</NavLink>
				<NavLink href="register">
					<span aria-hidden="true"></span> Register
				</NavLink>
			</ul>
		</nav>
	</NotAuthorized>
</AuthorizeView>

@code {
	private bool showMenu;

	private string GetFullName(AuthenticationState authState)
	{
		var firstName = GetClaim(authState, ClaimTypes.GivenName);
		var lastName = GetClaim(authState, ClaimTypes.Surname);
		return $"{firstName} {lastName}".Trim();
	}

	private string GetClaim(AuthenticationState authState, string claimType)
	{
		return authState.User.FindFirst(claimType)?.Value ?? "N/A";
	}

	private void ToggleMenu()
	{
		showMenu = !showMenu;
	}

	private void HideMenu(FocusEventArgs _)
	{
		showMenu = false;
	}
}
=== ./Pages/Shared/Dialog.razor ===
@* Reusable confirmation dialog for delete operations and other critical actions *@
@* src/CMC.Web/Pages/Shared/Dialog.razor *@
@if (IsOpen)
{
    <div class="confirm-backdrop" @onclick="HandleBackdropClick"></div>

    <div class="confirm-dialog confirm-dialog--open">
        <div class="card" @onclick:stopPropagation>
            <div class="confirm-header">
                <h3 id="confirm-title">@Title</h3>
            </div>

            <div class="confirm-body">
                <p>@Message</p>
                @if (!string.IsNullOrWhiteSpace(DetailMessage))
                {
                    <small class="text-muted">@DetailMessage</small>
                }
            </div>

            <div class="btn-group">
                <button class="btn danger" @onclick="Confirm" disabled="@_isProcessing">
                    @if (_isProcessing) { <span>Processing...</span> } else { @ConfirmText }
                </button>
                <button class="btn flat" @onclick="Cancel" disabled="@_isProcessing">
                    @CancelText
                </button>
            </div>
        </div>
    </div>
}


@code {
    /// <summary>
    /// Controls the visibility of the confirmation dialog.
    /// </summary>
    [Parameter] public bool IsOpen { get; set; }

    /// <summary>
    /// Title displayed in the dialog header.
    /// </summary>
    [Parameter] public string Title { get; set; } = "Confirm Action";

    /// <summary>
    /// Main confirmation message to display.
    /// </summary>
    [Parameter] public string Message { get; set; } = "Are you sure you want to proceed?";

    /// <summary>
    /// Optional detailed message for additional context.
    /// </summary>
    [Parameter] public string? DetailMessage { get; set; }

    /// <summary>
    /// Text for the confirmation button (default: "Confirm").
    /// </summary>
    [Parameter] public string ConfirmText { get; set; } = "Confirm";

    /// <summary>
    /// Text for the cancel button (default: "Cancel").
    /// </summary>
    [Parameter] public string CancelText { get; set; } = "Cancel";

    /// <summary>
    /// Callback invoked when user confirms the action.
    /// </summary>
    [Parameter] public EventCallback OnConfirm { get; set; }

    /// <summary>
    /// Callback invoked when user cancels the action.
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Controls whether clicking the backdrop should close the dialog.
    /// </summary>
    [Parameter] public bool CloseOnBackdropClick { get; set; } = true;

    private bool _isProcessing = false;

    /// <summary>
    /// Handles the confirmation action with async processing state.
    /// </summary>
    private async Task Confirm()
    {
        _isProcessing = true;
        StateHasChanged();

        try
        {
            await OnConfirm.InvokeAsync();
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Handles the cancel action.
    /// </summary>
    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    /// <summary>
    /// Handles backdrop clicks based on configuration.
    /// </summary>
    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick && !_isProcessing)
        {
            await Cancel();
        }
    }
}
=== ./Pages/Shared/RedirectToCockpit.razor ===
@inject NavigationManager Navigation

@code {
	protected override void OnInitialized()
	{
		Navigation.NavigateTo("/cockpit", true);
	}
}
=== ./Pages/Shared/NavMenu.razor ===
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Navigation

<header class="header-main">
    <AuthorizeView>
        <Authorized>
            <div>
            <a href="cockpit"><span class="audicius like-h1">CMC</span><span class="audicius">by Audicius</span></a></div>
        </Authorized>
        <NotAuthorized>
            <div>
            <a href=""><span class="audicius like-h1">CMC</span><span class="audicius">by Audicius</span></a></div>
        </NotAuthorized>
    </AuthorizeView>
    <ProfileMenu/>
</header>
=== ./Pages/Shared/ChoiceDialog.razor ===
@using CMC.Web.Services

@code {
	[Parameter] public bool IsOpen { get; set; }
	[Parameter] public string Title { get; set; } = "Auswahl";
	[Parameter] public string Message { get; set; } = "";
	[Parameter] public string ConfirmText { get; set; } = "√úbernehmen";
	[Parameter] public string CancelText { get; set; } = "Abbrechen";
	[Parameter] public bool MultiSelect { get; set; } = false;
	[Parameter] public List<DialogOption> Options { get; set; } = new();
	[Parameter] public EventCallback<IReadOnlyList<string>> OnConfirmKeys { get; set; }
	[Parameter] public EventCallback OnCancel { get; set; }

	private HashSet<string> _sel = new();

	private Task Toggle(string key)
	{
		if (MultiSelect)
		{
			if (!_sel.Add(key)) _sel.Remove(key);
		}
		else
		{
			_sel.Clear();
			_sel.Add(key);
		}
		return Task.CompletedTask;
	}

	private Task Confirm() => OnConfirmKeys.InvokeAsync(_sel.ToList());
	private Task Cancel()  => OnCancel.InvokeAsync();
}

@if (!IsOpen) { <text></text>; }
else
{
	<div class="dialog-backdrop" @onclick="Cancel">
		<div class="dialog" @onclick:stopPropagation="true">
			<h3>@Title</h3>
			@if (!string.IsNullOrWhiteSpace(Message))
			{
				<p>@Message</p>
			}

			<ul class="option-list">
				@foreach (var o in Options)
				{
					var isSelected = _sel.Contains(o.Key) || o.Selected;
					<li>
						<button type="button"
								class="option-btn @(isSelected ? "selected" : null)"
								@onclick="() => Toggle(o.Key)">
							@o.Label
						</button>
					</li>
				}
			</ul>

			<div class="dialog-actions">
				<button type="button" class="btn" @onclick="Cancel">@CancelText</button>
				<button type="button" class="btn primary" @onclick="Confirm">@ConfirmText</button>
			</div>
		</div>
	</div>
}
=== ./Pages/Shared/EditHost.razor ===
@using CMC.Web.Services
@inherits Microsoft.AspNetCore.Components.ComponentBase
@inject EditDrawerService DrawerService
@implements IDisposable

<!-- Wir geben den Request als Parameter an EditDrawer weiter -->
<EditDrawer Request="@_currentRequest" />

@code {
    private EditDrawerRequest? _currentRequest;

    protected override void OnInitialized()
    {
        DrawerService.OpenRequested += OnOpenRequested;
        DrawerService.CloseRequested += OnCloseRequested;
    }

    private void OnOpenRequested(EditDrawerRequest req)
    {
        // direkte Parameterversorgung -> Drawer rendert sofort auf
        _currentRequest = req;
        InvokeAsync(StateHasChanged);
        Console.WriteLine($"EditHost: Open '{req.Title}'");
    }

    private void OnCloseRequested()
    {
        _currentRequest = null;
        InvokeAsync(StateHasChanged);
        Console.WriteLine("EditHost: Close");
    }

    public void Dispose()
    {
        DrawerService.OpenRequested -= OnOpenRequested;
        DrawerService.CloseRequested -= OnCloseRequested;
    }
}
=== ./Pages/Shared/AutoTable.razor ===
@typeparam TItem
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using System.Linq
@attribute [Authorize]

<div class="relative">

  <div class="btn-group aud-table-interface">
    @if (AllowCreate)
    {
      <button type="button" class="btn xs flat" @onclick="RequestCreate">
        @CreateLabel
      </button>
    }
  </div>
  <table class="aud-table">
    <thead>
      <tr>
        @foreach (var col in _cols)
        {
          <th scope="col">@col.Header</th>
        }
        @if (AllowEdit)
        {
          <th scope="col" class="td-nowrap">Aktionen</th>
        }
      </tr>
    </thead>
    <tbody>
      @if (Items is not null)
      {
        @foreach (var item in Items)
        {
          <tr>
            @foreach (var col in _cols)
            {
              <td class="td-nowrap">@col.Render(item)</td>
            }
            @if (AllowEdit)
            {
              <td class="td-nowrap">
                @if (EditTemplate is not null)
                {
                  @EditTemplate(item)
                }
                else
                {
                  <button type="button" class="btn sm flat" @onclick="() => RequestEdit(item)">
                    Bearbeiten
                  </button>
                }
              </td>
            }
          </tr>
        }
      }
    </tbody>
  </table>
</div>

@code {
	[Parameter] public IEnumerable<TItem>? Items { get; set; }
	[Parameter] public bool AutoGenerate { get; set; } = true;

	// Edit
	[Parameter] public bool AllowEdit { get; set; } = false;
	[Parameter] public EventCallback<TItem> OnEdit { get; set; }
	[Parameter] public RenderFragment<TItem>? EditTemplate { get; set; }

	// Create (+)
	[Parameter] public bool AllowCreate { get; set; } = false;
	[Parameter] public EventCallback OnCreate { get; set; }
	[Parameter] public string CreateLabel { get; set; } = "+";

	private record Col(string Header, Func<TItem, object?> Getter, string? Format)
	{
		public RenderFragment Render(TItem item) => builder =>
		{
			var val = Getter(item);
			if (val is null) { builder.AddContent(0, string.Empty); return; }
			if (!string.IsNullOrWhiteSpace(Format) && val is IFormattable f)
				builder.AddContent(0, f.ToString(Format, null));
			else
				builder.AddContent(0, val.ToString());
		};
	}

	private List<Col> _cols = new();

	protected override void OnParametersSet()
	{
		if (!AutoGenerate || typeof(TItem).IsPrimitive) return;

		var props = typeof(TItem).GetProperties(BindingFlags.Public | BindingFlags.Instance)
			.Where(p => p.GetIndexParameters().Length == 0)
			.Where(p =>
			{
				var scaffoldAttr = p.GetCustomAttributes(true).OfType<ScaffoldColumnAttribute>().FirstOrDefault();
				if (scaffoldAttr is not null && scaffoldAttr.Scaffold == false) return false;
				var displayAttr = p.GetCustomAttributes(true).OfType<DisplayAttribute>().FirstOrDefault();
				if (displayAttr is not null && displayAttr.GetAutoGenerateField() == false) return false;
				return true;
			})
			.Select(p =>
			{
				var display = p.GetCustomAttributes(true).OfType<DisplayAttribute>().FirstOrDefault();
				var fmtAttr = p.GetCustomAttributes(true).OfType<DisplayFormatAttribute>().FirstOrDefault();

				var header = display?.GetName() ?? SplitPascal(p.Name);
				var order = display?.GetOrder() ?? int.MaxValue;

				string? cleanFmt = null;
				var fmt = fmtAttr?.DataFormatString;
				if (!string.IsNullOrWhiteSpace(fmt))
					cleanFmt = fmt.Contains(':') ? fmt[(fmt.IndexOf(':') + 1)..].TrimEnd('}') : fmt;

				Func<TItem, object?> getter = (TItem it) => p.GetValue(it);
				return (order, col: new Col(header, getter, cleanFmt));
			})
			.OrderBy(t => t.order)
			.Select(t => t.col)
			.ToList();

		_cols = props;
	}

	private static string SplitPascal(string s)
	{
		var sb = new System.Text.StringBuilder();
		for (int i = 0; i < s.Length; i++)
		{
			if (i > 0 && char.IsUpper(s[i]) && !char.IsUpper(s[i - 1])) sb.Append(' ');
			sb.Append(s[i]);
		}
		return sb.ToString();
	}

  private async Task RequestEdit(TItem item)
  {
    Console.WriteLine($"AutoTable: RequestEdit -> {typeof(TItem).Name}");
    if (OnEdit.HasDelegate)
      await OnEdit.InvokeAsync(item);
  }

  private async Task RequestCreate()
  {
    Console.WriteLine($"AutoTable: RequestCreate -> {typeof(TItem).Name}");
    if (OnCreate.HasDelegate)
      await OnCreate.InvokeAsync();
  }
}
=== ./Pages/Shared/MainFooter.razor ===
@using System.Security.Claims
@inject NavigationManager Navigation

<footer>
    <nav>
        <ul>
            <li class="subtle">
                <NavLink target="_blank" href="https://www.audicius.de/imprint">
                    <span aria-hidden="true"></span> Impressum
                </NavLink>
            </li>
            <li class="subtle">
                <NavLink target="_blank" href="https://www.audicius.de/privacy">
                    <span aria-hidden="true"></span> Datenschutz
                </NavLink>
            </li>
        </ul>
    </nav>
    <span class="subtle center"><span>¬© </span><span class="audicius">@DateTime.Now.Year Made by Audicius</span></span>
</footer>
=== ./Pages/Shared/RedirectToLogin.razor ===
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation

@code {
    protected override void OnInitialized()
    {
        Navigation.NavigateTo("/login");
    }
}
=== ./Pages/Shared/EditContextAdapter.cs ===
using System;
using System.Collections;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using System.Runtime.CompilerServices;
using CMC.Web.Services;

namespace CMC.Web.Shared;

public sealed class EditContextAdapter
{
	public EditDrawerRequest Request { get; }
	public object Model { get; }
	private readonly Dictionary<string, object?> _overrides;

	public EditContextAdapter(EditDrawerRequest request, object model)
	{
		Request = request ?? throw new ArgumentNullException(nameof(request));
		Model = model ?? throw new ArgumentNullException(nameof(model));
		_overrides = new(StringComparer.OrdinalIgnoreCase);
	}

	public EditContextAdapter(EditDrawerRequest request, object model, IDictionary<string, object?>? overrides)
	{
		Request = request ?? throw new ArgumentNullException(nameof(request));
		Model = model ?? throw new ArgumentNullException(nameof(model));
		_overrides = overrides as Dictionary<string, object?>
			?? (overrides != null
				? new Dictionary<string, object?>(overrides, StringComparer.OrdinalIgnoreCase)
				: new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase));
	}

	/// <summary>Optional: einzelne Feldwerte setzen/√ºberschreiben (falls dein FormRenderer das nutzt).</summary>
	public void Set(string name, object? value)
	{
		if (string.IsNullOrWhiteSpace(name)) return;
		_overrides[name] = value;
	}

	/// <summary>
	/// Baut per Konvention den Request-Typ:
	/// Kandidaten: {action}{ModelName}Request, {action}{ModelName}, {ModelName}{action}Request, {ModelName}{action}
	/// Beispiel: Model = UserDto, action="Register" -> RegisterUserRequest
	/// </summary>
	public object Build(string action)
	{
		if (Request.ContractsAssembly == null)
			throw new InvalidOperationException("ContractsAssembly ist nicht gesetzt.");

		var modelName = StripSuffix(Model.GetType().Name, "Dto");
		var candidates = new[]
		{
			$"{action}{modelName}Request",
			$"{action}{modelName}",
			$"{modelName}{action}Request",
			$"{modelName}{action}"
		};

		var targetType = Request.ContractsAssembly
			.GetTypes()
			.FirstOrDefault(t => candidates.Any(c => string.Equals(t.Name, c, StringComparison.OrdinalIgnoreCase)));

		if (targetType == null)
			throw new InvalidOperationException($"Kein Request-Typ f√ºr Aktion '{action}' und Model '{modelName}' gefunden (gesucht: {string.Join(", ", candidates)}).");

		// ---------------- Wert-Vorrat zusammenstellen (Model -> ExtraFields -> Overrides) ----------------
		var bag = new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase);

		foreach (var sp in Model.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance))
		{
			if (!sp.CanRead) continue;
			bag[sp.Name] = sp.GetValue(Model);
		}

		if (Request.ExtraFields is { Count: > 0 })
		{
			foreach (var ef in Request.ExtraFields)
				bag[ef.Name] = ef.Value;
		}

		if (_overrides.Count > 0)
		{
			foreach (var kv in _overrides)
				bag[kv.Key] = kv.Value;
		}

		// ---------------- Instanz anlegen ----------------
		object? instance = TryCreateWithParameterlessCtor(targetType)
						   ?? TryCreateWithBestMatchingCtor(targetType, bag)
						   ?? FormatterServices.GetUninitializedObject(targetType); // letzter Ausweg

		// ---------------- Properties nachziehen (nur schreibbar & nicht init-only) ----------------
		MapByName(bag, instance);

		return instance!;
	}

	// ========================= Erzeugungs-Strategien =========================

	private static object? TryCreateWithParameterlessCtor(Type targetType)
	{
		var hasDefault = targetType.GetConstructors(BindingFlags.Public | BindingFlags.Instance)
								   .Any(c => c.GetParameters().Length == 0);
		return hasDefault ? Activator.CreateInstance(targetType) : null;
	}

	private object? TryCreateWithBestMatchingCtor(Type targetType, IDictionary<string, object?> bag)
	{
		var ctors = targetType.GetConstructors(BindingFlags.Public | BindingFlags.Instance);
		if (ctors.Length == 0) return null;

		// Score: wie viele Parameter k√∂nnen wir bef√ºllen (oder haben Default)?
		var best = ctors
			.Select(c =>
			{
				var ps = c.GetParameters();
				int matched = 0;
				bool allBindable = true;

				foreach (var p in ps)
				{
					if (bag.ContainsKey(p.Name!)) { matched++; continue; }
					if (p.HasDefaultValue) continue;

					// Werttypen ohne Default sind nicht bindbar
					if (Nullable.GetUnderlyingType(p.ParameterType) is null && p.ParameterType.IsValueType)
					{
						allBindable = false;
						break;
					}
				}

				return new { Ctor = c, Params = ps, Matched = matched, AllBindable = allBindable };
			})
			// nur die, die wir vollst√§ndig bef√ºllen k√∂nnen (oder Defaults/Nulle zulassen)
			.Where(x => x.AllBindable)
			.OrderByDescending(x => x.Matched)
			.ThenBy(x => x.Params.Length)
			.FirstOrDefault();

		if (best is null) return null;

		var args = new object?[best.Params.Length];
		for (int i = 0; i < best.Params.Length; i++)
		{
			var p = best.Params[i];
			if (bag.TryGetValue(p.Name!, out var raw))
			{
				args[i] = ConvertToType(raw, p.ParameterType);
			}
			else if (p.HasDefaultValue)
			{
				args[i] = p.DefaultValue;
			}
			else
			{
				// null oder default(T) f√ºr nicht-bindbare optionale
				args[i] = GetNullDefault(p.ParameterType);
			}
		}

		return best.Ctor.Invoke(args);
	}

	// ========================= Mapping Helpers =========================

	/// <summary>
	/// Werte aus Bag per Name auf das Zielobjekt mappen (nur schreibbare & nicht init-only Properties).
	/// </summary>
	private static void MapByName(IDictionary<string, object?> sourceBag, object target)
	{
		var tgtProps = target.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance)
			.Where(p => p.CanWrite && !IsInitOnly(p))
			.ToDictionary(p => p.Name, p => p, StringComparer.OrdinalIgnoreCase);

		foreach (var (name, val) in sourceBag)
		{
			if (!tgtProps.TryGetValue(name, out var tp)) continue;
			var converted = ConvertToType(val, tp.PropertyType);
			tp.SetValue(target, converted);
		}
	}

	private static bool TrySet(object target, string propName, object? value)
	{
		var p = target.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
		if (p == null || !p.CanWrite || IsInitOnly(p)) return false;

		var converted = ConvertToType(value, p.PropertyType);
		p.SetValue(target, converted);
		return true;
	}

	private static bool IsInitOnly(PropertyInfo p)
	{
		var set = p.SetMethod;
		if (set is null) return true;
		// init-only: hat den Modifizierer IsExternalInit
		var mods = set.ReturnParameter?.GetRequiredCustomModifiers() ?? Type.EmptyTypes;
		return mods.Contains(typeof(IsExternalInit));
	}

	private static object? ConvertToType(object? value, Type targetType)
	{
		if (value == null) return GetNullDefault(targetType);

		var nonNullTarget = Nullable.GetUnderlyingType(targetType) ?? targetType;

		// Bereits passend?
		if (nonNullTarget.IsInstanceOfType(value)) return value;

		// String-Quelle?
		if (value is string s)
		{
			if (nonNullTarget == typeof(Guid))
				return Guid.TryParse(s, out var g) ? g : GetNullDefault(targetType);

			if (nonNullTarget == typeof(DateTime))
				return DateTime.TryParse(s, CultureInfo.InvariantCulture, DateTimeStyles.RoundtripKind, out var dt) ? dt : GetNullDefault(targetType);

			if (nonNullTarget.IsEnum)
				return Enum.TryParse(nonNullTarget, s, true, out var ev) ? ev : GetNullDefault(targetType);

			// Zahlen / bool
			try
			{
				return System.Convert.ChangeType(s, nonNullTarget, CultureInfo.InvariantCulture);
			}
			catch { /* fallthrough */ }
		}

		// IEnumerable<string> -> List<Guid> / List<int> / ...
		if (IsGenericList(nonNullTarget, out var itemType))
		{
			if (value is IEnumerable enumerable)
			{
				var list = (IList)Activator.CreateInstance(typeof(List<>).MakeGenericType(itemType))!;
				foreach (var obj in enumerable)
				{
					var elem = obj;
					if (obj is string es)
					{
						elem = ConvertStringTo(es, itemType);
					}
					else if (obj != null && !itemType.IsInstanceOfType(obj))
					{
						elem = System.Convert.ChangeType(obj, itemType, CultureInfo.InvariantCulture);
					}
					list.Add(elem!);
				}
				return list;
			}
		}

		// Alles andere: ChangeType versuchen
		try
		{
			return System.Convert.ChangeType(value, nonNullTarget, CultureInfo.InvariantCulture);
		}
		catch
		{
			return GetNullDefault(targetType);
		}
	}

	private static object? ConvertStringTo(string s, Type itemType)
	{
		var nn = Nullable.GetUnderlyingType(itemType) ?? itemType;

		if (nn == typeof(Guid))
			return Guid.TryParse(s, out var g) ? g : GetNullDefault(itemType);

		if (nn == typeof(DateTime))
			return DateTime.TryParse(s, CultureInfo.InvariantCulture, DateTimeStyles.RoundtripKind, out var dt) ? dt : GetNullDefault(itemType);

		if (nn.IsEnum)
			return Enum.TryParse(nn, s, true, out var ev) ? ev : GetNullDefault(itemType);

		try
		{
			return System.Convert.ChangeType(s, nn, CultureInfo.InvariantCulture);
		}
		catch
		{
			return GetNullDefault(itemType);
		}
	}

	private static bool IsGenericList(Type t, out Type itemType)
	{
		itemType = typeof(object);
		if (!t.IsGenericType) return false;
		if (t.GetGenericTypeDefinition() != typeof(List<>)) return false;
		itemType = t.GetGenericArguments()[0];
		return true;
	}

	private static object? GetNullDefault(Type t)
	{
		var nn = Nullable.GetUnderlyingType(t) ?? t;
		if (nn.IsValueType && Nullable.GetUnderlyingType(t) == null)
		{
			// non-nullable value type -> default(T)
			return Activator.CreateInstance(nn);
		}
		return null;
	}

	private static string StripSuffix(string name, string suffix)
	{
		return name.EndsWith(suffix, StringComparison.OrdinalIgnoreCase)
			? name[..^suffix.Length]
			: name;
	}
}
=== ./Pages/Shared/DialogHost.razor ===
@inject CMC.Web.Services.DialogService Dialogs
@implements IDisposable

<Dialog IsOpen="@_dlgOpen"
        Title="@(_dlgReq?.Title ?? "")"
        Message="@(_dlgReq?.Message ?? "")"
        ConfirmText="@(_dlgReq?.ConfirmText ?? "OK")"
        CancelText="@_dlgReq?.CancelText"
        OnConfirm="HandleDlgConfirm"
        OnCancel="HandleDlgCancel" />

<ChoiceDialog
    IsOpen="@_choiceOpen"
    Title="@(_choiceReq?.Title ?? string.Empty)"
    Message="@(_choiceReq?.Message ?? string.Empty)"
    ConfirmText="@(_choiceReq?.ConfirmText ?? "√úbernehmen")"
    CancelText="@(_choiceReq?.CancelText ?? "Abbrechen")"
    Options="@_choiceOptions"
    MultiSelect="@(_choiceReq?.MultiSelect ?? false)"
    OnConfirmKeys="HandleChoiceConfirm"
    OnCancel="HandleChoiceCancel" />

@code {
    // --- Confirm/Info Dialog ---
    private bool _dlgOpen;
    private DialogRequest? _dlgReq;

    // --- Choice Dialog (dein bestehendes) ---
    private bool _choiceOpen;
    private ChoiceRequest? _choiceReq;
    private List<DialogOption> _choiceOptions = new();

    protected override void OnInitialized()
    {
        Dialogs.OnOpen += OpenDialog;
        Dialogs.OnOpenChoice += OpenChoice;
    }

    private void OpenDialog(DialogRequest req)
    {
        _dlgReq = req;
        _dlgOpen = true;
        StateHasChanged();
    }

    private async Task HandleDlgConfirm()
    {
        var cb = _dlgReq?.OnConfirm;
        _dlgOpen = false; StateHasChanged();
        if (cb is not null) await cb();
    }

    private async Task HandleDlgCancel()
    {
        var cb = _dlgReq?.OnCancel;
        _dlgOpen = false; StateHasChanged();
        if (cb is not null) await cb();
    }

    private void OpenChoice(ChoiceRequest req)
    {
        _choiceReq = req;
        _choiceOptions = req.Options?.ToList() ?? new();
        _choiceOpen = true;
        StateHasChanged();
    }

    private async Task HandleChoiceConfirm(IReadOnlyList<string> keys)
    {
        var cb = _choiceReq?.OnConfirm;
        _choiceOpen = false; StateHasChanged();
        if (cb is not null) await cb(keys);
    }

    private async Task HandleChoiceCancel()
    {
        var cb = _choiceReq?.OnCancel;
        _choiceOpen = false; StateHasChanged();
        if (cb is not null) await cb();
    }

    public void Dispose()
    {
        Dialogs.OnOpen -= OpenDialog;
        Dialogs.OnOpenChoice -= OpenChoice;
    }
}
=== ./Pages/Index.razor ===
@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject IJSRuntime JS

<PageTitle>CMC - Home</PageTitle>

<section class="slim">
    <div class="card">
        <h1>
            Welcome to Cybersecurity Management Cockpit
        </h1>
    </div>
</section>
<section class="slim">
	<div class="card">
		<h2>Button Variants (ungrouped)</h2>

		<!-- primary -->
		<p><strong>primary</strong></p>
		<a class="btn primary" href="#">Link </a>
		<NavLink class="btn primary" href="#">NavLink</NavLink>
		<button class="btn primary" @onclick='() => Alert("Primary clicked!")'>Button</button>

		<!-- secondary -->
		<p><strong>secondary</strong></p>
		<a class="btn secondary" href="#">Link </a>
		<NavLink class="btn secondary" href="#">NavLink</NavLink>
		<button class="btn secondary" @onclick='() => Alert("Sekund√§r clicked!")'>Button</button>

		<!-- flat -->
		<p><strong>flat</strong></p>
		<a class="btn flat" href="#">Link </a>
		<NavLink class="btn flat" href="#">NavLink</NavLink>
		<button class="btn flat" @onclick='() => Alert("Flat clicked!")'>Button</button>

		<!-- danger -->
		<p><strong>danger</strong></p>
		<a class="btn danger" href="#">Link </a>
		<NavLink class="btn danger" href="#">NavLink</NavLink>
		<button class="btn danger" @onclick='() => Alert("Danger clicked!")'>Button</button>

		<!-- primary -->
		<p><strong>primary</strong></p>
		<a class="btn sm primary" href="#">Link </a>
		<NavLink class="btn sm primary" href="#">NavLink</NavLink>
		<button class="btn sm primary" @onclick='() => Alert("Primary clicked!")'>Button</button>

		<!-- secondary -->
		<p><strong>secondary</strong></p>
		<a class="btn sm secondary" href="#">Link </a>
		<NavLink class="btn sm secondary" href="#">NavLink</NavLink>
		<button class="btn sm secondary" @onclick='() => Alert("Sekund√§r clicked!")'>Button</button>

		<!-- flat -->
		<p><strong>flat</strong></p>
		<a class="btn sm flat" href="#">Link </a>
		<NavLink class="btn sm flat" href="#">NavLink</NavLink>
		<button class="btn sm flat" @onclick='() => Alert("Flat clicked!")'>Button</button>

		<!-- danger -->
		<p><strong>danger</strong></p>
		<a class="btn sm danger" href="#">Link </a>
		<NavLink class="btn sm danger" href="#">NavLink</NavLink>
		<button class="btn sm danger" @onclick='() => Alert("Danger clicked!")'>Button</button>
	</div>

	<div class="card">
		<h2>Button Variants (grouped)</h2>

		<p><strong>primary</strong></p>
		<div class="btn-group">
			<a class="btn primary" href="#">Link </a>
			<NavLink class="btn primary" href="#">NavLink</NavLink>
			<button class="btn primary" @onclick='() => Alert("Primary in group!")'>Button</button>
		</div>

		<p><strong>secondary</strong></p>
		<div class="btn-group">
			<a class="btn secondary" href="#">Link </a>
			<NavLink class="btn secondary" href="#">NavLink</NavLink>
			<button class="btn secondary" @onclick='() => Alert("Secondary in group!")'>Button</button>
		</div>

		<p><strong>flat</strong></p>
		<div class="btn-group">
			<a class="btn flat" href="#">Link </a>
			<NavLink class="btn flat" href="#">NavLink</NavLink>
			<button class="btn flat" @onclick='() => Alert("Flat in group!")'>Button</button>
		</div>

		<p><strong>danger</strong></p>
		<div class="btn-group">
			<a class="btn danger" href="#">Link </a>
			<NavLink class="btn danger" href="#">NavLink</NavLink>
			<button class="btn danger" @onclick='() => Alert("Danger in group!")'>Button</button>
		</div>

		<p><strong>primary</strong></p>
		<div class="btn-group">
			<a class="btn sm primary" href="#">Link </a>
			<NavLink class="btn sm primary" href="#">NavLink</NavLink>
			<button class="btn sm primary" @onclick='() => Alert("Primary in group!")'>Button</button>
		</div>

		<p><strong>secondary</strong></p>
		<div class="btn-group">
			<a class="btn sm secondary" href="#">Link </a>
			<NavLink class="btn sm secondary" href="#">NavLink</NavLink>
			<button class="btn sm secondary" @onclick='() => Alert("Secondary in group!")'>Button</button>
		</div>

		<p><strong>flat</strong></p>
		<div class="btn-group">
			<a class="btn sm flat" href="#">Link </a>
			<NavLink class="btn sm flat" href="#">NavLink</NavLink>
			<button class="btn sm flat" @onclick='() => Alert("Flat in group!")'>Button</button>
		</div>

		<p><strong>danger</strong></p>
		<div class="btn-group">
			<a class="btn sm danger" href="#">Link </a>
			<NavLink class="btn sm danger" href="#">NavLink</NavLink>
			<button class="btn sm danger" @onclick='() => Alert("Danger in group!")'>Button</button>
		</div>
	</div>
</section>
<section class="slim">
    <div class="card">
        <h1>
            Form
        </h1>

		<form action="#" method="post" autocomplete="on">

			<fieldset>
				<legend>Profil</legend>

				<div class="form-group">
					<label for="name">Vollst√§ndiger Name</label>
					<input id="name" name="name" type="text" class="form-control"
						autocomplete="name" required />
				</div>

				<div class="form-group">
					<label for="email">E-Mail</label>
					<input id="email" name="email" type="email" class="form-control"
						autocomplete="email" inputmode="email" required />
					<small id="email-help">Wir teilen deine E-Mail nicht.</small>
				</div>

				<div class="form-group">
					<label for="password">Passwort</label>
					<input id="password" name="password" type="password" class="form-control"
						autocomplete="new-password" minlength="8" required aria-describedby="pw-help" />
					<small id="pw-help">Mind. 8 Zeichen.</small>
				</div>

				<div class="form-group">
					<label for="tel">Telefon</label>
					<input id="tel" name="tel" type="tel" class="form-control"
						autocomplete="tel" inputmode="tel" placeholder="+49 123 456789" />
				</div>
			</fieldset>

			<fieldset>
				<legend>Eingaben</legend>

				<div class="form-group">
					<label for="username">Username (mit Vorschl√§gen)</label>
					<input id="username" name="username" type="text" class="form-control" list="user-suggestions" />
					<datalist id="user-suggestions">
						<option value="jonathan42"></option>
						<option value="jkjeberle"></option>
						<option value="dev-jon"></option>
					</datalist>
				</div>

				<div class="form-group">
					<label for="search">Suche</label>
					<input id="search" name="search" type="search" class="form-control" inputmode="search" />
				</div>

				<div class="form-group">
					<label for="url">Website</label>
					<input id="url" name="url" type="url" class="form-control" placeholder="https://example.com" />
				</div>

				<div class="form-group">
					<label for="number">Zahl (0‚Äì100)</label>
					<input id="number" name="number" type="number" class="form-control" min="0" max="100" step="1" />
				</div>

				<div class="form-group">
					<label for="range">Range (Live-Ausgabe)</label>
					<input id="range" name="range" type="range" min="0" max="10" value="5"
						oninput="range_out.value=this.value" />
					<output id="range_out" for="range">5</output>
				</div>

				<div class="form-group">
					<label for="color">Farbe</label>
					<input id="color" name="color" type="color" value="#4f46e5" />
				</div>

				<div class="form-group">
					<label for="file">Datei(en)</label>
					<input id="file" name="file" type="file" multiple accept=".png,.jpg,.jpeg,.pdf" />
				</div>

				<div class="form-group">
					<label for="bio">Kurzbio</label>
					<textarea id="bio" name="bio" class="form-control" rows="4" maxlength="500" spellcheck="true"></textarea>
				</div>

				<div class="form-group">
					<label for="select">Auswahl</label>
					<select id="select" name="select" class="form-control" required>
						<option value="" disabled selected>Bitte w√§hlen‚Ä¶</option>
						<optgroup label="Gruppe A">
							<option value="a1">A1</option>
							<option value="a2">A2</option>
						</optgroup>
						<optgroup label="Gruppe B">
							<option value="b1">B1</option>
							<option value="b2">B2</option>
						</optgroup>
					</select>
				</div>
			</fieldset>

			<!-- Zeit & Datum -->
			<fieldset>
				<legend>Zeit & Datum</legend>

				<div class="form-group">
					<label for="date">Datum</label>
					<input id="date" name="date" type="date" />
				</div>

				<div class="form-group">
					<label for="time">Uhrzeit</label>
					<input id="time" name="time" type="time" />
				</div>

				<div class="form-group">
					<label for="datetime">Lokal (Datum & Zeit)</label>
					<input id="datetime" name="datetime" type="datetime-local" />
				</div>

				<div class="form-group">
					<label for="month">Monat</label>
					<input id="month" name="month" type="month" />
				</div>

				<div class="form-group">
					<label for="week">Kalenderwoche</label>
					<input id="week" name="week" type="week" />
				</div>
			</fieldset>

			<fieldset>
				<legend>Optionen</legend>

				<div class="form-group">
					<span id="rad-legend">Radio</span><br />
					<input id="r1" name="radio" type="radio" value="1" aria-labelledby="rad-legend" />
					<label for="r1">Option 1</label>
					<input id="r2" name="radio" type="radio" value="2" />
					<label for="r2">Option 2</label>
				</div>

				<div class="form-group">
					<span id="chk-legend">Checkboxen</span><br />
					<input id="c1" name="features" type="checkbox" value="f1" aria-labelledby="chk-legend" />
					<label for="c1">Feature 1</label>
					<input id="c2" name="features" type="checkbox" value="f2" />
					<label for="c2">Feature 2</label>
				</div>
			</fieldset>

			<fieldset>
				<legend>Extras</legend>

				<div class="form-group">
					<label for="meter">Fortschritt (Meter)</label>
					<meter id="meter" min="0" max="100" low="30" high="70" optimum="85" value="60">60</meter>
				</div>

				<div class="form-group">
					<label for="progress">Upload (Progress)</label>
					<progress id="progress" value="0" max="100">0%</progress>
				</div>

				<input type="hidden" name="hidden_token" value="abc123" />
			</fieldset>

			<div class="form-group">
				<button type="submit" class="btn primary">Absenden</button>
				<button type="reset" class="btn flat">Zur√ºcksetzen</button>
			</div>
		</form>
    </div>
</section>
<section class="slim">
    <div class="card">
        <h1>
            Test
        </h1><div class="table-wrap table-sm" style="--col-1-w: 22ch; --col-2-w: 16ch; --col-3-w: 34ch; --col-4-w: 12ch; --col-5-w: 12ch;">
    <table class="aud-table">
        <colgroup>
            <col />
            <col />
            <col />
            <col />
            <col />
        </colgroup>
        <thead>
            <tr>
                <th scope="col">Order #</th>
                <th scope="col">Date</th>
                <th scope="col">Customer</th>
                <th scope="col">Total</th>
                <th scope="col">Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td data-label="Order #" class="td-nowrap">ORD-2025-0001</td>
                <td data-label="Date" class="td-nowrap">2025-08-01</td>
                <td data-label="Customer" class="td-truncate">Acme Industries GmbH, Procurement Team South-West</td>
                <td data-label="Total" class="td-num">1 249,00 ‚Ç¨</td>
                <td data-label="Status"><span class="td-badge success">Paid</span></td>
            </tr>
            <tr>
                <td data-label="Order #" class="td-nowrap">ORD-2025-0002</td>
                <td data-label="Date" class="td-nowrap">2025-08-03</td>
                <td data-label="Customer" class="td-truncate">M√ºller & S√∂hne KG</td>
                <td data-label="Total" class="td-num">219,90 ‚Ç¨</td>
                <td data-label="Status"><span class="td-badge warn">Pending</span></td>
            </tr>
            <tr>
                <td data-label="Order #" class="td-nowrap">ORD-2025-0003</td>
                <td data-label="Date" class="td-nowrap">2025-08-05</td>
                <td data-label="Customer" class="td-truncate">Globex Europe AG</td>
                <td data-label="Total" class="td-num">9 870,00 ‚Ç¨</td>
                <td data-label="Status"><span class="td-badge danger">Overdue</span></td>
            </tr>
        </tbody>
    </table>
</div>
    </div>
</section>

<AuthorizeView>
    <Authorized>
        <RedirectToCockpit />
    </Authorized>
    <NotAuthorized>
    </NotAuthorized>
</AuthorizeView>

@code {
	private async Task Alert(string message)
	{
		await JS.InvokeVoidAsync("alert", message);
	}
}
=== ./Pages/Logout.razor ===
@page "/logout"
@inject NavigationManager Navigation

@code {
    protected override void OnInitialized()
    {
        // Einfache Weiterleitung zu AuthController
        Navigation.NavigateTo("/api/auth/logout", true);
    }
}
=== ./Pages/Login.razor ===
@page "/login"
@using CMC.Contracts.Users
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Login</PageTitle>

<section class="slim">
    <div class="card">
        <h2>Login</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        <EditForm Model="@loginRequest" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="email">Email:</label>
                <InputText id="email" class="form-control" @bind-Value="loginRequest.Email" />
                <ValidationMessage For="@(() => loginRequest.Email)" />
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <InputText id="password" type="password" class="form-control" @bind-Value="loginRequest.Password" />
                <ValidationMessage For="@(() => loginRequest.Password)" />
            </div>

            <button type="submit" class="btn primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Logging in...</span>
                }
                else
                {
                    <span>Login</span>
                }
            </button>
        </EditForm>

        <p>
            Don't have an account? <a href="/register">Register here</a>
        </p>
        <p>
            <a href="/forgot-password">Forgot Password?</a>
        </p>

    </div>
</section>
@code {
    private LoginRequest loginRequest = new()
    {
        Email = string.Empty,
        Password = string.Empty
    };
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            Logger.LogInformation("üîê Login attempt for: {Email}", loginRequest.Email);

            // Sende Login-Request an API Controller
            var response = await JSRuntime.InvokeAsync<bool>("submitLoginForm", loginRequest);

            if (response)
            {
                Logger.LogInformation("‚úÖ Login successful for: {Email}", loginRequest.Email);
                successMessage = "Login successful! Redirecting...";
                StateHasChanged();

                // Warte kurz und lade die Seite neu f√ºr Auth-State Update
                await Task.Delay(1000);
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Logger.LogWarning("‚ùå Login failed for: {Email}", loginRequest.Email);
                errorMessage = "Invalid email or password";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Login error for: {Email}", loginRequest.Email);
            errorMessage = "An unexpected error occurred.";
        }
        finally
        {
            isLoading = false;
        }
    }

}
=== ./Pages/ForgotPassword.razor ===
@page "/forgot-password"
@using CMC.Application.Services
@inject UserService UserService

<PageTitle>Forgot Password</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-4">
        <h2>Forgot Password</h2>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-info">@message</div>
        }

        <EditForm Model="@emailModel" OnValidSubmit="@HandleForgotPassword">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="email">Email:</label>
                <InputText id="email" class="form-control" @bind-Value="emailModel.Email" />
                <ValidationMessage For="@(() => emailModel.Email)" />
            </div>

            <button type="submit" class="btn primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Sending...</span>
                }
                else
                {
                    <span>Send Reset Link</span>
                }
            </button>
        </EditForm>

        <hr />
        <p>
            <a href="/login">Back to Login</a>
        </p>
    </div>
</div>

@code {
    public class EmailModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;
    }

    private EmailModel emailModel = new();
    private string message = string.Empty;
    private bool isLoading = false;

    private async Task HandleForgotPassword()
    {
        try
        {
            isLoading = true;
            message = string.Empty;

            await UserService.RequestPasswordResetAsync(emailModel.Email);
            message = "If an account with that email exists, a password reset link has been sent.";

            emailModel.Email = string.Empty;
        }
        catch (Exception)
        {
            message = "An error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
=== ./Pages/CockpitPages/CockpitOverview.razor ===
@* CockpitPages/CockpitOverview.razor *@
<div class="card">
    <h2>√úbersicht</h2>
</div>
=== ./Pages/CockpitPages/CockpitScenarios.razor ===
@* CockpitPages/CockpitScenarios.razor *@
<div class="card">
    <h2>Szenarien</h2>
</div>
=== ./Pages/CockpitPages/CockpitCustomers.razor ===
@using System.Linq
@using CMC.Contracts.Customers
@using CMC.Web.Services
@inject CMC.Application.Services.CustomerService CustomerService
@inject EditDrawerService DrawerService
@inject DialogService ConfirmService

<div class="card">
    <AutoTable TItem="CustomerDto"
               Items="_customers"
               AllowEdit="true"
               OnEdit="StartEdit"
               AllowCreate="true"
               OnCreate="StartCreate" />
</div>

@code {
    private List<CustomerDto> _customers = new();

    protected override async Task OnInitializedAsync()
        => _customers = await CustomerService.GetAllAsync();

    private async Task Reload()
    {
        _customers = await CustomerService.GetAllAsync();
        StateHasChanged();
    }

    private void StartEdit(CustomerDto c)
    {
        var req = new EditDrawerRequest
        {
            Title = "Kunde bearbeiten",
            Model = c,
            ContractsAssembly = typeof(CustomerDto).Assembly, // <-- WICHTIG
            IsCreate = false,
            OnSave = async ctx =>
            {
                try
                {
                    var up = (UpdateCustomerRequest)ctx.Build("Update");
                    _ = await CustomerService.UpdateAsync(up);
                    await Reload();
                    DrawerService.Close();
                }
                catch (Exception ex)
                {
                    ConfirmService.Open(new DialogRequest
                    {
                        Title = "Fehler beim Speichern",
                        Message = ex.Message,
                        ConfirmText = "Okay",
                        OnConfirm = () => Task.CompletedTask
                    });
                }
            },
            OnDelete = async ctx =>
            {
                var model = (CustomerDto)ctx.Model;

                ConfirmService.Open(new DialogRequest
                {
                    Title = "L√∂schen best√§tigen",
                    Message = $"Firma ‚Äû{model.Name}‚Äú wirklich l√∂schen?",
                    ConfirmText = "L√∂schen",
                    OnConfirm = async () =>
                    {
                        try
                        {
                            await CustomerService.DeleteAsync(new DeleteCustomerRequest(model.Id));
                            await Reload();
                            DrawerService.Close();
                        }
                        catch (Exception ex)
                        {
                            ConfirmService.Open(new DialogRequest
                            {
                                Title = "L√∂schen fehlgeschlagen",
                                Message = ex.Message,
                                ConfirmText = "Okay",
                                OnConfirm = () => Task.CompletedTask
                            });
                        }
                    }
                });
            }
        };

        DrawerService.Open(req);
    }

    private void StartCreate()
    {
        var empty = new CustomerDto(
            Id: Guid.Empty,
            Name: "",
            Industry: "",
            EmployeeCount: 0,
            RevenuePerYear: 0m,
            IsActive: true,
            CreatedAt: DateTime.UtcNow,
            UpdatedAt: DateTime.UtcNow,
            UserCount: 0
        );

        DrawerService.Open(new EditDrawerRequest
        {
            Title = "Firma anlegen",
            Model = empty,
            ContractsAssembly = typeof(CustomerDto).Assembly, // <-- WICHTIG
            IsCreate = true,
            OnSave = async ctx =>
            {
                try
                {
                    var req = (CreateCustomerRequest)ctx.Build("Create");
                    _ = await CustomerService.CreateAsync(req);
                    await Reload();
                    DrawerService.Close();
                }
                catch (Exception ex)
                {
                    ConfirmService.Open(new DialogRequest
                    {
                        Title = "Fehler beim Anlegen",
                        Message = ex.Message,
                        ConfirmText = "Okay",
                        OnConfirm = () => Task.CompletedTask
                    });
                }
            }
        });
    }
}
=== ./Pages/CockpitPages/CockpitUsers.razor ===
@using System.Linq
@using CMC.Contracts.Users
@using CMC.Web.Shared
@using CMC.Web.Services
@using CMC.Domain.Entities

@inject CMC.Application.Services.UserService UserService
@inject EditDrawerService DrawerService
@inject DialogService ConfirmService

<div class="card">
	<AutoTable TItem="UserDto"
			   Items="_users"
			   AllowEdit="true"
			   OnEdit="StartEdit"
			   AllowCreate="true"
			   OnCreate="StartCreate" />
</div>

@code {
	private List<UserDto> _users = new();

	protected override async Task OnInitializedAsync()
	{
		_users = await UserService.GetAllAsync();
	}

	private async Task ReloadAsync()
	{
		_users = await UserService.GetAllAsync();
		StateHasChanged();
	}

	private async Task<EditDrawerRequest> BuildUserDrawer(UserDto model, bool isCreate)
	{
		var req = new EditDrawerRequest
		{
			Title = isCreate ? "Benutzer anlegen" : "Benutzer bearbeiten",
			Model = model,
			ContractsAssembly = typeof(UserDto).Assembly,
			IsCreate = isCreate,

			// F√ºr relation-auto (FormRenderer l√§dt Optionen via Rels + EfParentType)
			EfParentType = typeof(User),
			GetParentKey = m => ((UserDto)m).Id,

			OnSave = async ctx =>
			{
				try
				{
					if (isCreate)
					{
						var reg = (RegisterUserRequest)ctx.Build("Register");
						_ = await UserService.RegisterAsync(reg);
					}
					else
					{
						var up = (UpdateUserRequest)ctx.Build("Update");
						await UserService.UpdateAsync(up);
					}

					await ReloadAsync();
					DrawerService.Close();
				}
				catch (Exception ex)
				{
					ConfirmService.Open(new DialogRequest
					{
						Title = "Fehler",
						Message = ex.Message,
						ConfirmText = "Okay",
						OnConfirm = () => Task.CompletedTask
					});
				}
			},

			OnDelete = async ctx =>
			{
				var m = (UserDto)ctx.Model;

				ConfirmService.Open(new DialogRequest
				{
					Title = "L√∂schen best√§tigen",
					Message = $"Benutzer ‚Äû{m.FirstName} {m.LastName}‚Äú wirklich l√∂schen?",
					ConfirmText = "L√∂schen",
					OnConfirm = async () =>
					{
						try
						{
							await UserService.DeleteAsync(new DeleteUserRequest(m.Id));
							await ReloadAsync();
							DrawerService.Close();
						}
						catch (Exception ex)
						{
							ConfirmService.Open(new DialogRequest
							{
								Title = "L√∂schen fehlgeschlagen",
								Message = ex.Message,
								ConfirmText = "Okay",
								OnConfirm = () => Task.CompletedTask
							});
						}
					}
				});
			}
		};

		// Passwort nur bei Create
		if (isCreate)
		{
			req.ExtraFields.Add(new ExtraField(
				Name: "Password",
				Label: "Passwort",
				Type: typeof(string),
				ReadOnly: false,
				Hint: "Mindestens 8 Zeichen",
				DataType: "password"
			));
		}

		// Firma als relation-auto -> FormRenderer rendert <select> aus Rels.LoadOptions()
		req.ExtraFields.Add(new ExtraField(
			Name: "CustomerId",
			Label: "Firma",
			Type: typeof(Guid?),
			ReadOnly: false,
			Hint: "Aus Liste w√§hlen.",
			DataType: "relation-auto"
		));

		return req;
	}

	private async Task StartEdit(UserDto u)
		=> DrawerService.Open(await BuildUserDrawer(u, isCreate: false));

	private async Task StartCreate()
	{
		var empty = new UserDto(
			Id: Guid.Empty,
			Email: "",
			FirstName: "",
			LastName: "",
			Role: "",
			Department: "",
			IsEmailConfirmed: false,
			CreatedAt: DateTime.UtcNow,
			LastLoginAt: null,
			CustomerId: null,
			CustomerName: null
		);

		DrawerService.Open(await BuildUserDrawer(empty, isCreate: true));
	}
}
=== ./Pages/_Host.cshtml ===
@page "/"
@namespace CMC.Web.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMC</title>
    <base href="~/" />
    <link rel="stylesheet" href="~/style.css" asp-append-version="true" />
    <script src="js/cockpit.js"></script>
</head>
<body>
    <component type="typeof(App)" render-mode="Server" />
    <script src="_framework/blazor.server.js"></script>
    <script>
        // üîß Login Form Submit Helper
        window.submitLoginForm = async function(loginRequest) {
            try {
                console.log('üîê Submitting login form...', loginRequest);

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginRequest),
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Login successful');
                    return true;
                } else {
                    console.log('‚ùå Login failed:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                return false;
            }
        };
    </script>
</body>
</html>
=== ./Pages/Profile.razor ===
@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]

<PageTitle>Profile</PageTitle>

<section class="slim">
    <div class="card">
        <h1>User Profile</h1>
        <AuthorizeView>
            <Authorized>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@GetFullName(context)</h5>
                        <p class="card-text">
                            <strong>Email:</strong> @context.User.Identity?.Name<br />
                            <strong>User ID:</strong> @GetUserId(context)<br />
                            <strong>First Name:</strong> @GetClaim(context, System.Security.Claims.ClaimTypes.GivenName)<br />
                            <strong>Last Name:</strong> @GetClaim(context, System.Security.Claims.ClaimTypes.Surname)
                        </p>
                    </div>
                </div>
            </Authorized>
        </AuthorizeView>
    </div>
</section>

@code {
    private string GetFullName(AuthenticationState authState)
    {
        var firstName = GetClaim(authState, System.Security.Claims.ClaimTypes.GivenName);
        var lastName = GetClaim(authState, System.Security.Claims.ClaimTypes.Surname);
        return $"{firstName} {lastName}".Trim();
    }

    private string GetUserId(AuthenticationState authState)
    {
        return GetClaim(authState, System.Security.Claims.ClaimTypes.NameIdentifier);
    }

    private string GetClaim(AuthenticationState authState, string claimType)
    {
        return authState.User.FindFirst(claimType)?.Value ?? "N/A";
    }
}
=== ./Pages/ResetPassword.razor ===
@page "/reset-password"
@using CMC.Application.Services
@using CMC.Contracts.Users
@inject UserService UserService
@inject NavigationManager Navigation

<PageTitle>Reset Password</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-4">
        <h2>Reset Password</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        <EditForm Model="@resetRequest" OnValidSubmit="@HandleResetPassword">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="token">Reset Token:</label>
                <InputText id="token" class="form-control" @bind-Value="resetRequest.Token" />
                <ValidationMessage For="@(() => resetRequest.Token)" />
            </div>

            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <InputText id="newPassword" type="password" class="form-control" @bind-Value="resetRequest.NewPassword" />
                <ValidationMessage For="@(() => resetRequest.NewPassword)" />
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm New Password:</label>
                <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="confirmPassword" />
                @if (!string.IsNullOrEmpty(confirmPassword) && resetRequest.NewPassword != confirmPassword)
                {
                    <div class="text-danger">Passwords do not match.</div>
                }
            </div>

            <button type="submit" class="btn primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Resetting...</span>
                }
                else
                {
                    <span>Reset Password</span>
                }
            </button>
        </EditForm>

        <hr />
        <p>
            <a href="/login">Back to Login</a>
        </p>
    </div>
</div>

@code {
    private ResetPasswordRequest resetRequest = new()
    {
        Token = string.Empty,
        NewPassword = string.Empty
    };
    private string confirmPassword = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    protected override void OnInitialized()
    {
        // Get token from query string if provided
        var uri = new Uri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("token", out var token))
        {
            resetRequest.Token = token.ToString();
        }
    }

    private async Task HandleResetPassword()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            if (resetRequest.NewPassword != confirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }

            var success = await UserService.ResetPasswordAsync(resetRequest);
            if (success)
            {
                successMessage = "Password reset successful! You can now login with your new password.";
                resetRequest = new()
                {
                    Token = string.Empty,
                    NewPassword = string.Empty
                };
                confirmPassword = string.Empty;
            }
            else
            {
                errorMessage = "Invalid or expired reset token.";
            }
        }
        catch (Exception)
        {
            errorMessage = "An error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
=== ./Pages/Register.razor ===
@page "/register"
@using CMC.Application.Services
@using CMC.Contracts.Users
@using CMC.Domain.Common
@inject UserService UserService
@inject NavigationManager Navigation

<PageTitle>Register</PageTitle>

<section class="slim">
    <div class="card">
        <h1>
            Register
        </h1>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        <EditForm Model="@registerRequest" OnValidSubmit="@HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="firstName">First Name:</label>
                <InputText id="firstName" class="form-control" @bind-Value="registerRequest.FirstName" />
                <ValidationMessage For="@(() => registerRequest.FirstName)" />
            </div>

            <div class="form-group">
                <label for="lastName">Last Name:</label>
                <InputText id="lastName" class="form-control" @bind-Value="registerRequest.LastName" />
                <ValidationMessage For="@(() => registerRequest.LastName)" />
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <InputText id="email" class="form-control" @bind-Value="registerRequest.Email" />
                <ValidationMessage For="@(() => registerRequest.Email)" />
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <InputText id="password" type="password" class="form-control" @bind-Value="registerRequest.Password" />
                <ValidationMessage For="@(() => registerRequest.Password)" />
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="confirmPassword" />
                @if (!string.IsNullOrEmpty(confirmPassword) && registerRequest.Password != confirmPassword)
                {
                    <div class="text-danger">Passwords do not match.</div>
                }
            </div>

            <button type="submit" class="btn primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Registering...</span>
                }
                else
                {
                    <span>Register</span>
                }
            </button>
        </EditForm>

        <p>
            Already have an account? <a href="/login">Login here</a>
        </p>
    </div>
</section>

@code {
    private RegisterUserRequest registerRequest = new()
    {
        FirstName = string.Empty,
        LastName = string.Empty,
        Email = string.Empty,
        Password = string.Empty
    };
    private string confirmPassword = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            if (registerRequest.Password != confirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }

            var user = await UserService.RegisterAsync(registerRequest);
            successMessage = "Registration successful! You can now login.";

            // Clear form
            registerRequest = new()
            {
                FirstName = string.Empty,
                LastName = string.Empty,
                Email = string.Empty,
                Password = string.Empty
            };
            confirmPassword = string.Empty;
        }
        catch (DomainException domainEx)
        {
            errorMessage = domainEx.Message;
        }
        catch
        {
            errorMessage = "An error occurred during registration. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
=== ./Pages/Cockpit.razor ===
@* Pages/Cockpit.razor *@
@attribute [Authorize]
@page "/cockpit"
@page "/cockpit/{*Section}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using CMC.Web.Pages.CockpitPages
@inject NavigationManager Navigation

<PageTitle>CMC - Cockpit</PageTitle>

<div class="cockpit">
	<aside class="aside-main">
		<ul class="menu-root">
			@RenderNodes(Nodes)
		</ul>
	</aside>

	<div class="board">
		@RenderContent()
	</div>
</div>

@code {
	[Parameter] public string? Section { get; set; }

	private readonly HashSet<string> _open = new();

	private List<MenuNode> Nodes = new()
	{
		new MenuNode
		{
			Id = "customers",
			Text = "Firmenkunden",
			Href = "/cockpit/customers",
			Match = NavLinkMatch.All,
			Component = typeof(CockpitCustomers)
		},
		new MenuNode
		{
			Id = "users",
			Text = "Benutzer",
			Href = "/cockpit/users",
			Match = NavLinkMatch.All,
			Component = typeof(CockpitUsers)
		},
	};

	protected override void OnInitialized()
	{
		Navigation.LocationChanged += HandleLocationChanged;
		UpdateSectionFromUri();
		ExpandAncestorsForCurrentPath();
	}

	protected override void OnParametersSet()
	{
		UpdateSectionFromUri();
		ExpandAncestorsForCurrentPath();
	}

	private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
	{
		UpdateSectionFromUri();
		ExpandAncestorsForCurrentPath();
		InvokeAsync(StateHasChanged);
	}

	private void UpdateSectionFromUri()
	{
		var path = Navigation.ToBaseRelativePath(Navigation.Uri);

		if (path.StartsWith("cockpit/"))
		{
			Section = path.Substring("cockpit/".Length);
		}
		else if (path == "cockpit" || path == "cockpit/")
		{
			Section = "overview";
		}
	}

	// ---------- MENU RENDER ----------
	private RenderFragment RenderNodes(IEnumerable<MenuNode> nodes) => builder =>
	{
		var seq = 0;
		foreach (var node in nodes)
		{
			var isOpen = _open.Contains(node.Id);
			var hasChildren = node.Children?.Any() == true;

			builder.OpenElement(seq++, "li");
			builder.AddAttribute(seq++, "class", $"menu-node {(hasChildren ? "has-children" : "")} {(isOpen ? "open" : "")}");

			builder.OpenElement(seq++, "div");
			builder.AddAttribute(seq++, "class", "menu-row");
			builder.AddAttribute(seq++, "role", hasChildren ? "button" : null);
			builder.AddAttribute(seq++, "aria-expanded", hasChildren ? isOpen.ToString().ToLower() : null);
			builder.AddAttribute(seq++, "aria-controls", hasChildren ? $"sub-{node.Id}" : null);

			if (!string.IsNullOrWhiteSpace(node.Href))
			{
				builder.OpenComponent<NavLink>(seq++);
				builder.AddAttribute(seq++, "href", node.Href);
				if (node.Match.HasValue) builder.AddAttribute(seq++, "Match", node.Match.Value);
				builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, () => OnNodeClicked(node)));
				builder.AddAttribute(seq++, "ChildContent", (RenderFragment)(b => b.AddContent(seq++, node.Text)));
				builder.CloseComponent();
			}
			else
			{
				builder.OpenElement(seq++, "span");
				builder.AddAttribute(seq++, "class", "menu-label");
				if (hasChildren)
				{
					builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, () => OnNodeClicked(node)));
					builder.AddAttribute(seq++, "tabindex", "0");
				}
				builder.AddContent(seq++, node.Text);
				builder.CloseElement();
			}

			builder.CloseElement(); // .menu-row

			if (hasChildren)
			{
				builder.OpenElement(seq++, "ul");
				builder.AddAttribute(seq++, "id", $"sub-{node.Id}");
				builder.AddAttribute(seq++, "class", "submenu");
				if (!isOpen) builder.AddAttribute(seq++, "hidden", "hidden");
				builder.AddContent(seq++, RenderNodes(node.Children!));
				builder.CloseElement();
			}

			builder.CloseElement(); // li
		}
	};

	// ---------- CONTENT RENDER (einzige Version!) ----------
	private RenderFragment RenderContent() => builder =>
	{
		var currentPath = "/" + Navigation.ToBaseRelativePath(Navigation.Uri).TrimEnd('/');
		if (string.IsNullOrWhiteSpace(currentPath) || currentPath == "/cockpit")
			currentPath = "/cockpit";

		var activeNode = FindNodeByHref(Nodes, currentPath);
		var componentType = activeNode?.Component ?? typeof(CockpitOverview);

		builder.OpenComponent(0, componentType);
		builder.CloseComponent();
	};

	// ---------- HELPERS ----------
	private MenuNode? FindNodeByHref(IEnumerable<MenuNode> nodes, string path)
	{
		foreach (var node in nodes)
		{
			if (!string.IsNullOrWhiteSpace(node.Href) &&
				string.Equals(node.Href.TrimEnd('/'), path.TrimEnd('/'), StringComparison.OrdinalIgnoreCase))
			{
				return node;
			}

			if (node.Children?.Any() == true)
			{
				var child = FindNodeByHref(node.Children, path);
				if (child != null) return child;
			}
		}
		return null;
	}

	private void OnNodeClicked(MenuNode node)
	{
		if (node.Children?.Any() == true)
			Toggle(node.Id);
	}

	private void Toggle(string id)
	{
		if (_open.Contains(id)) _open.Remove(id);
		else _open.Add(id);
	}

	private void ExpandAncestorsForCurrentPath()
	{
		var currentPath = "/" + Navigation.ToBaseRelativePath(Navigation.Uri);
		var active = FindPathByHref(Nodes, currentPath);
		if (active is null || active.Count == 0) return;

		foreach (var ancestor in active)
			_open.Add(ancestor.Id);
	}

	private List<MenuNode>? FindPathByHref(IEnumerable<MenuNode> nodes, string currentPath)
	{
		foreach (var n in nodes)
		{
			var isMatch = !string.IsNullOrWhiteSpace(n.Href) &&
				(string.Equals(n.Href!.TrimEnd('/'), currentPath.TrimEnd('/'), StringComparison.OrdinalIgnoreCase)
					|| (currentPath.StartsWith(n.Href!.TrimEnd('/') + "/", StringComparison.OrdinalIgnoreCase)));

			if (isMatch) return new List<MenuNode> { n };

			if (n.Children?.Any() == true)
			{
				var childPath = FindPathByHref(n.Children!, currentPath);
				if (childPath != null)
				{
					childPath.Insert(0, n);
					return childPath;
				}
			}
		}
		return null;
	}

	public void Dispose()
	{
		Navigation.LocationChanged -= HandleLocationChanged;
	}

	private class MenuNode
	{
		public string Id { get; set; } = Guid.NewGuid().ToString("N");
		public string Text { get; set; } = "";
		public string? Href { get; set; }
		public NavLinkMatch? Match { get; set; } = NavLinkMatch.Prefix;
		public List<MenuNode>? Children { get; set; }
		public Type? Component { get; set; } // <-- neu
	}
}
=== ./appsettings.Production.json ===
{
  "ConnectionStrings": {
    "DefaultConnection": ""
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning",
      "Microsoft.AspNetCore.Hosting.Diagnostics": "Warning",
      "Microsoft.AspNetCore.DataProtection": "Warning",
      "Microsoft.AspNetCore.Authentication": "Information"
    },
  "Console": {
      "IncludeScopes": false,
      "LogLevel": { "Default": "Information" }
    },
    "File": {
      "Path": "/var/log/cmc-app/cmc-app-.txt",
      "LogLevel": { "Default": "Information" }
    }
  },
  "AllowedHosts": "*",
  "DetailedErrors": false,
  "Kestrel": {
    "Endpoints": {
      "Http": { "Url": "http://localhost:5000" }
    }
  },
  "Security": {
    "RequireHttpsMetadata": false,
    "CookieSecure": false,
    "UseHsts": false
  }
}
=== ./Services/RelationDialogService.cs ===
using System.Linq;

namespace CMC.Web.Services;

public sealed class RelationDialogService
{
    private readonly DialogService _dialogs;
    private readonly IRelationshipManager _rels;

    public RelationDialogService(DialogService dialogs, IRelationshipManager rels)
    {
        _dialogs = dialogs;
        _rels = rels;
    }

    public async Task OpenForAsync(object parent, string relationName)
    {
        var desc = _rels.GetDescriptor(parent.GetType(), relationName);
        if (desc.Kind == RelationKind.OneToMany)
        {
            _dialogs.Open(new DialogRequest
            {
                Title = relationName,
                Message = "Diese Relation ist 1:n und wird als Liste angezeigt."
            });
            return;
        }

        var options = (await desc.LoadOptions()).Select(o => new DialogOption(o.Value, o.Label)).ToList();
        var current = (await desc.LoadCurrentKeys(parent)).ToHashSet();

        _dialogs.Open(new ChoiceRequest
        {
            Title = relationName,
            Message = desc.Kind == RelationKind.Reference ? "Bitte ausw√§hlen" : "Mehrfachauswahl m√∂glich",
            MultiSelect = desc.Kind == RelationKind.ManyToMany,
            Options = options.Select(o => o with { Selected = current.Contains(o.Key) }).ToList(),
            OnConfirm = async keys =>
            {
                if (desc.Kind == RelationKind.Reference && desc.SetReference != null)
                {
                    var key = keys.FirstOrDefault();
                    if (key != null) await desc.SetReference(parent, key);
                    return;
                }

                if (desc.Kind == RelationKind.ManyToMany && desc.AddMany != null && desc.RemoveMany != null)
                {
                    var newSet = keys.ToHashSet();
                    var toAdd = newSet.Except(current).ToArray();
                    var toRem = current.Except(newSet).ToArray();
                    if (toAdd.Length > 0) await desc.AddMany(parent, toAdd);
                    if (toRem.Length > 0) await desc.RemoveMany(parent, toRem);
                }
            }
        });
    }

    public async Task OpenForAsync(Type parentType, object parentKey, string relationName)
    {
        var parent = await _rels.FindParentAsync(parentType, parentKey);
        await OpenForAsync(parent, relationName);
    }
}
=== ./Services/Relations.cs ===
using System.Reflection;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.AspNetCore.Mvc.ModelBinding;
namespace CMC.Web.Services
{
	public enum RelationKind { Reference, OneToMany, ManyToMany }

	public sealed record RelationOption(string Label, string Value);

	public sealed class RelationDescriptor
	{
		public required string Name { get; init; }
		public required RelationKind Kind { get; init; }
		public required Type ParentType { get; init; }
		public required Type TargetType { get; init; }
		public required Func<Task<IEnumerable<RelationOption>>> LoadOptions { get; init; }
		public required Func<object, Task<IEnumerable<string>>> LoadCurrentKeys { get; init; }
		public Func<object, string, Task>? SetReference { get; init; }
		public Func<object, IEnumerable<string>, Task>? AddMany { get; init; }
		public Func<object, IEnumerable<string>, Task>? RemoveMany { get; init; }
	}

	public interface IRelationshipManager
	{
		RelationDescriptor GetDescriptor(Type parentType, string relationName);
		RelationDescriptor GetDescriptor<TParent>(string relationName) where TParent : class;
		Task<object> FindParentAsync(Type parentType, object key);
	}

	public sealed class RelationshipManager<TDbContext> : IRelationshipManager where TDbContext : DbContext
	{
		private readonly TDbContext _db;

		public RelationshipManager(TDbContext db) { _db = db; }

		public RelationDescriptor GetDescriptor<TParent>(string relationName) where TParent : class
			=> GetDescriptor(typeof(TParent), relationName);

		public RelationDescriptor GetDescriptor(Type parentType, string relationName)
		{
			var model = _db.Model;
			var parentEt = model.FindEntityType(parentType)
				?? throw new InvalidOperationException($"EntityType not found: {parentType.Name}");

			var nav = parentEt.FindNavigation(relationName);
			if (nav is not null)
			{
				var targetEt = nav.TargetEntityType;
				return nav.IsCollection
					? BuildOneToMany(parentType, relationName, targetEt)
					: BuildReference(parentType, relationName, targetEt);
			}

			var skip = parentEt.FindSkipNavigation(relationName);
			if (skip is not null)
			{
				return BuildManyToMany(parentType, relationName, skip.TargetEntityType);
			}

			throw new InvalidOperationException($"Relation '{relationName}' not found on {parentType.Name}");
		}

		public async Task<object> FindParentAsync(Type parentType, object key)
		{
			var set = GetSetNonGeneric(parentType);
			var pk = _db.Model.FindEntityType(parentType)!.FindPrimaryKey()!;
			var keyProp = pk.Properties.Single().PropertyInfo!;
			var typed = Convert.ChangeType(key, keyProp.PropertyType);
			var findAsync = set.GetType().GetMethod("FindAsync", new[] { typeof(object[]) })!;
			var vt = (ValueTask<object?>)findAsync.Invoke(set, new object[] { new object?[] { typed! } })!;
			var entity = await vt;
			if (entity is null) throw new InvalidOperationException($"{parentType.Name}({key}) not found");
			return entity;
		}

		private RelationDescriptor BuildReference(Type parentType, string rel, IEntityType targetEt)
		{
			var targetClr = targetEt.ClrType;
			return new RelationDescriptor
			{
				Name = rel,
				Kind = RelationKind.Reference,
				ParentType = parentType,
				TargetType = targetClr,
				LoadOptions = async () =>
				{
					var set = GetSetNonGeneric(targetClr);
					var list = await ToListAsync(set);
					return list.Select(e => new RelationOption(GetDisplay(e), GetKey(e)!));
				},
				LoadCurrentKeys = async parent =>
				{
					await _db.Entry(parent).Reference(rel).LoadAsync();
					var obj = _db.Entry(parent).Reference(rel).CurrentValue;
					return obj is null ? Array.Empty<string>() : new[] { GetKey(obj)! };
				},
				SetReference = async (parent, key) =>
				{
					var entity = await FindByKey(targetClr, key);
					_db.Entry(parent).Reference(rel).CurrentValue = entity;
					await _db.SaveChangesAsync();
				}
			};
		}

		private RelationDescriptor BuildOneToMany(Type parentType, string rel, IEntityType targetEt)
		{
			return new RelationDescriptor
			{
				Name = rel,
				Kind = RelationKind.OneToMany,
				ParentType = parentType,
				TargetType = targetEt.ClrType,
				LoadOptions = () => Task.FromResult<IEnumerable<RelationOption>>(Array.Empty<RelationOption>()),
				LoadCurrentKeys = async parent =>
				{
					await _db.Entry(parent).Collection(rel).LoadAsync();
					var children = (IEnumerable<object>)(_db.Entry(parent).Collection(rel).CurrentValue ?? Array.Empty<object>());
					return children.Select(GetKey!).Where(k => k is not null)!;
				}
			};
		}

		private RelationDescriptor BuildManyToMany(Type parentType, string rel, IEntityType targetEt)
		{
			var targetClr = targetEt.ClrType;
			return new RelationDescriptor
			{
				Name = rel,
				Kind = RelationKind.ManyToMany,
				ParentType = parentType,
				TargetType = targetClr,
				LoadOptions = async () =>
				{
					var set = GetSetNonGeneric(targetClr);
					var list = await ToListAsync(set);
					return list.Select(e => new RelationOption(GetDisplay(e), GetKey(e)!));
				},
				LoadCurrentKeys = async parent =>
				{
					await _db.Entry(parent).Collection(rel).LoadAsync();
					var curr = (IEnumerable<object>)(_db.Entry(parent).Collection(rel).CurrentValue ?? Array.Empty<object>());
					return curr.Select(GetKey!).Where(k => k is not null)!;
				},
				AddMany = async (parent, keys) =>
				{
					await _db.Entry(parent).Collection(rel).LoadAsync();
					var coll = (IList<object>)_db.Entry(parent).Collection(rel).CurrentValue!;
					foreach (var k in keys)
					{
						var entity = await FindByKey(targetClr, k);
						if (!coll.Contains(entity)) coll.Add(entity);
					}
					await _db.SaveChangesAsync();
				},
				RemoveMany = async (parent, keys) =>
				{
					await _db.Entry(parent).Collection(rel).LoadAsync();
					var coll = (IList<object>)_db.Entry(parent).Collection(rel).CurrentValue!;
					foreach (var k in keys.ToList())
					{
						var entity = await FindByKey(targetClr, k);
						if (coll.Contains(entity)) coll.Remove(entity);
					}
					await _db.SaveChangesAsync();
				}
			};
		}

        private static async Task<List<object>> ToListAsync(object set)
        {
            // DbSet<TEntity> implementiert IQueryable<TEntity>
            var entityClr = set.GetType().GetGenericArguments()[0];

            var toListAsync = typeof(EntityFrameworkQueryableExtensions)
                .GetMethods()
                .First(m => m.Name == "ToListAsync"
                    && m.IsGenericMethodDefinition
                    && m.GetParameters().Length == 2)
                .MakeGenericMethod(entityClr);

            var query = (IQueryable)set;
            var task = (Task)toListAsync.Invoke(null, new object[] { query, CancellationToken.None })!;
            await task.ConfigureAwait(false);

            var resultProp = task.GetType().GetProperty("Result")!;
            return ((IEnumerable<object>)resultProp.GetValue(task)!).ToList();
        }

		private async Task<object> FindByKey(Type clr, string key)
		{
			var set = GetSetNonGeneric(clr);
			var pk = _db.Model.FindEntityType(clr)!.FindPrimaryKey()!;
			var keyProp = pk.Properties.Single().PropertyInfo!;
			var typed = Convert.ChangeType(key, keyProp.PropertyType);
			var findAsync = set.GetType().GetMethod("FindAsync", new[] { typeof(object[]) })!;
			var vt = (ValueTask<object?>)findAsync.Invoke(set, new object[] { new object?[] { typed! } })!;
			var e = await vt;
			if (e is null) throw new InvalidOperationException($"{clr.Name}({key}) not found");
			return e;
		}

		private static string? GetKey(object e)
		{
			var idProp = e.GetType().GetProperties().FirstOrDefault(p => string.Equals(p.Name, "Id", StringComparison.OrdinalIgnoreCase));
			return idProp?.GetValue(e)?.ToString();
		}

		private static string GetDisplay(object e)
		{
			var p = e.GetType().GetProperty("Name") ?? e.GetType().GetProperty("Title");
			var val = p?.GetValue(e)?.ToString();
			return string.IsNullOrWhiteSpace(val) ? e.ToString() ?? "(?)" : val!;
		}
        private object GetSetNonGeneric(Type clr)
        {
            // 1) Versuche non-generic DbContext.Set(Type) (falls vorhanden)
            var miNonGeneric = typeof(DbContext).GetMethod("Set", new[] { typeof(Type) });
            if (miNonGeneric != null)
            {
                var set = miNonGeneric.Invoke(_db, new object[] { clr });
                if (set != null) return set;
            }

            // 2) Fallback: generische Definition DbContext.Set<TEntity>() schlie√üen
            var miGeneric = typeof(DbContext).GetMethods(BindingFlags.Public | BindingFlags.Instance)
                .First(m => m.Name == "Set" && m.IsGenericMethodDefinition && m.GetParameters().Length == 0);

            var closed = miGeneric.MakeGenericMethod(clr);
            return closed.Invoke(_db, null)!;
        }
	}
}
=== ./Services/EditDrawerService.cs ===
using System.Collections.Concurrent;
using System.Reflection; // <- This was missing
using CMC.Web.Shared;

namespace CMC.Web.Services;
public sealed class EditDrawerRequest
{
	public string Title { get; init; } = "";
	public object Model { get; init; } = default!;
	public Assembly ContractsAssembly { get; init; } = default!;
	public bool IsCreate { get; init; }
	public Func<EditContextAdapter, Task> OnSave { get; init; } = _ => Task.CompletedTask;
	public Func<EditContextAdapter, Task>? OnDelete { get; init; }

	// NEU: F√ºr relation-auto
	public Type? EfParentType { get; init; }          // z.B. typeof(User)
	public Func<object, object>? GetParentKey { get; init; } // z.B. m => ((UserDto)m).Id

	public List<ExtraField> ExtraFields { get; } = new();
}
public sealed class EditDrawerService
{
	public event Action? StackChanged;

	public event Action<EditDrawerRequest>? OpenRequested;
	public event Action? CloseRequested;
	private readonly List<Frame> _stack = new();
	private record Frame(EditDrawerRequest Request, TaskCompletionSource<object?>? Result);

	public IReadOnlyList<EditDrawerRequest> Stack => _stack.Select(f => f.Request).ToList();

		// Open anpassen
	public void Open(EditDrawerRequest request)
	{
		Push(new Frame(request, null));
		OpenRequested?.Invoke(request);
	}


	public Task<T?> OpenForResult<T>(EditDrawerRequest request)
	{
		var tcs = new TaskCompletionSource<object?>(TaskCreationOptions.RunContinuationsAsynchronously);
		Push(new Frame(request, tcs));
		return tcs.Task.ContinueWith(t => (T?)t.Result);
	}

	// Close anpassen
	public void Close(object? result = null)
	{
		if (_stack.Count == 0) return;
		var top = _stack[^1];
		_stack.RemoveAt(_stack.Count - 1);
		top.Result?.TrySetResult(result);
		StackChanged?.Invoke();
		CloseRequested?.Invoke();
	}

	private void Push(Frame frame)
	{
		_stack.Add(frame);
		StackChanged?.Invoke();
	}
}
=== ./Services/EntityManager.cs ===
// src/CMC.Web/Services/EntityManager.cs
using System.Reflection;
using CMC.Web.Shared;

namespace CMC.Web.Services;

/// <summary>
///  entity manager that works with any entity type using reflection and conventions
/// </summary>
public class EntityManager
{
    private readonly IServiceProvider _serviceProvider;
    private readonly Assembly _contractsAssembly;
    private readonly EditDrawerService _drawerService;
    private readonly DialogService _dialogService;

    public EntityManager(IServiceProvider serviceProvider, EditDrawerService drawerService, DialogService dialogService)
    {
        _serviceProvider = serviceProvider;
        _contractsAssembly = typeof(CMC.Contracts.Users.UserDto).Assembly;
        _drawerService = drawerService;
        _dialogService = dialogService;
    }

    /// <summary>
    /// Generic edit method that works for any entity type
    /// </summary>
    public void StartEdit<TDto>(TDto item, Func<Task> onSuccess, List<ExtraField>? extraFields = null) where TDto : class
    {
        var entityName = GetEntityDisplayName<TDto>();

        var req = new EditDrawerRequest
        {
            Title = $"{entityName} bearbeiten",
            Model = item,
            ContractsAssembly = _contractsAssembly,
            IsCreate = false,
            OnSave = async ctx =>
            {
                try
                {
                    var updateRequest = ctx.Build("Update");
                    await CallServiceMethod<TDto>("UpdateAsync", updateRequest);
                    await onSuccess();
                    _drawerService.Close();
                }
                catch (Exception ex)
                {
                    ShowError("Fehler beim Speichern", ex.Message);
                }
            },
            OnDelete = async ctx =>
            {
                await HandleDelete(item, onSuccess);
            }
        };

        // Add entity-specific extra fields
        if (extraFields != null)
            req.ExtraFields.AddRange(extraFields);
        else
            req.ExtraFields.AddRange(GenerateDefaultExtraFields<TDto>(item));

        _drawerService.Open(req);
    }

    /// <summary>
    /// Generic create method that works for any entity type
    /// </summary>
    public void StartCreate<TDto>(TDto emptyItem, Func<Task> onSuccess, List<ExtraField>? extraFields = null) where TDto : class
    {
        var entityName = GetEntityDisplayName<TDto>();

        var req = new EditDrawerRequest
        {
            Title = $"{entityName} anlegen",
            Model = emptyItem,
            ContractsAssembly = _contractsAssembly,
            IsCreate = true,
            OnSave = async ctx =>
            {
                try
                {
                    var createRequest = ctx.Build("Create");
                    await CallServiceMethod<TDto>("CreateAsync", createRequest);
                    await onSuccess();
                    _drawerService.Close();
                }
                catch (Exception ex)
                {
                    ShowError("Fehler beim Anlegen", ex.Message);
                }
            }
        };

        if (extraFields != null)
            req.ExtraFields.AddRange(extraFields);
        else
            req.ExtraFields.AddRange(GenerateDefaultExtraFields<TDto>(emptyItem, true));

        _drawerService.Open(req);
    }

    /// <summary>
    /// Handles delete with automatic relationship detection
    /// </summary>
    private async Task HandleDelete<TDto>(TDto item, Func<Task> onSuccess) where TDto : class
    {
        var itemId = GetEntityId(item);
        var itemName = GetEntityDisplayName(item);
        var entityTypeName = GetEntityDisplayName<TDto>();

        // Try to get dependent count
        var dependentCount = await GetDependentCount<TDto>(itemId);

        if (dependentCount == 0)
        {
            // Simple delete
            _dialogService.ConfirmDelete(itemName, async () =>
            {
                try
                {
                    await CallServiceMethod<TDto>("DeleteAsync", itemId);
                    await onSuccess();
                    _drawerService.Close();
                }
                catch (Exception ex)
                {
                    ShowError("L√∂schen fehlgeschlagen", ex.Message);
                }
            }, entityTypeName);
        }
        else
        {
            // Delete with dependencies - use enhanced choice dialog
            _dialogService.ConfirmDeleteWithRelations(itemName, dependentCount, async (strategy) =>
            {
                try
                {
                    switch (strategy)
                    {
                        case "cascade":
                            await CallServiceMethod<TDto>("DeleteCascadeAsync", itemId);
                            break;
                        case "detach":
                            await CallServiceMethod<TDto>("DetachAndDeleteAsync", itemId);
                            break;
                        default:
                            return; // Cancel
                    }
                    await onSuccess();
                    _drawerService.Close();
                }
                catch (Exception ex)
                {
                    ShowError("L√∂schen fehlgeschlagen", ex.Message);
                }
            }, entityTypeName);
        }
    }

    /// <summary>
    /// Automatically generates extra fields based on conventions
    /// </summary>
    private List<ExtraField> GenerateDefaultExtraFields<TDto>(TDto item, bool isCreate = false) where TDto : class
    {
        var extraFields = new List<ExtraField>();
        var itemType = typeof(TDto);

        // Add password field for user creation
        if (isCreate && itemType.Name.Contains("User"))
        {
            extraFields.Add(new ExtraField(
                Name: "Password",
                Label: "Passwort",
                Type: typeof(string),
                ReadOnly: false,
                Hint: "Mindestens 8 Zeichen",
                DataType: "password"
            ));
        }

        // Auto-detect foreign key relationships
        var foreignKeyProps = itemType.GetProperties()
            .Where(p => p.Name.EndsWith("Id") && p.PropertyType == typeof(Guid?))
            .Where(p => p.Name != "Id"); // Exclude primary key

        foreach (var fkProp in foreignKeyProps)
        {
            var relationName = fkProp.Name.Substring(0, fkProp.Name.Length - 2); // Remove "Id"
            var currentValue = fkProp.GetValue(item);

            extraFields.Add(CreateRelationField(relationName, currentValue));
        }

        return extraFields;
    }

    /// <summary>
    /// Creates a relation field automatically
    /// </summary>
    private ExtraField CreateRelationField(string relationName, object? currentValue)
    {
        return new ExtraField(
            Name: $"{relationName}Id",
            Label: GetDisplayName(relationName),
            Type: typeof(Guid?),
            ReadOnly: false,
            Hint: $"{GetDisplayName(relationName)} suchen oder neu anlegen.",
            DataType: "relation-single",
            Value: currentValue,
            Options: new(),
            OnCreateNew: () => CreateRelatedEntityInline(relationName),
            OnSearch: (term) => SearchRelatedEntities(relationName, term),
            DebounceMs: 300
        );
    }

    /// <summary>
    /// Search for related entities by convention
    /// </summary>
    private async Task<List<KeyValuePair<string, string>>> SearchRelatedEntities(string relationName, string term)
    {
        try
        {
            var serviceType = GetServiceType(relationName);
            if (serviceType == null) return new();

            var service = _serviceProvider.GetRequiredService(serviceType);
            var method = serviceType.GetMethod("GetAllAsync");
            if (method == null) return new();

            var result = method.Invoke(service, new object[] { CancellationToken.None });
            if (result is not Task task) return new();

            await task;

            var items = task.GetType().GetProperty("Result")?.GetValue(task) as System.Collections.IEnumerable;
            if (items == null) return new();

            var filteredItems = new List<KeyValuePair<string, string>>();

            foreach (var item in items)
            {
                var id = GetEntityId(item).ToString();
                var name = GetEntityDisplayName(item);

                if (string.IsNullOrWhiteSpace(term) ||
                    name.Contains(term, StringComparison.OrdinalIgnoreCase))
                {
                    filteredItems.Add(new KeyValuePair<string, string>(name, id));
                }
            }

            return filteredItems;
        }
        catch
        {
            return new();
        }
    }

    /// <summary>
    /// Create related entity inline
    /// </summary>
    private async Task<KeyValuePair<string, string>?> CreateRelatedEntityInline(string relationName)
    {
        try
        {
            // This would need to be implemented based on your specific entities
            // For now, return null to indicate no inline creation
            return null;
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// Gets service type by convention
    /// </summary>
    private Type? GetServiceType(string entityName)
    {
        var serviceName = $"CMC.Application.Services.{entityName}Service";
        return AppDomain.CurrentDomain.GetAssemblies()
            .SelectMany(a => a.GetTypes())
            .FirstOrDefault(t => t.FullName == serviceName);
    }

    /// <summary>
    /// Gets service type for a DTO
    /// </summary>
    private Type? GetServiceType<TDto>()
    {
        var dtoName = typeof(TDto).Name;
        if (dtoName.EndsWith("Dto"))
            dtoName = dtoName.Substring(0, dtoName.Length - 3);

        return GetServiceType(dtoName);
    }

    /// <summary>
    /// Calls service method dynamically
    /// </summary>
    private async Task CallServiceMethod<TDto>(string methodName, object parameter)
    {
        var serviceType = GetServiceType<TDto>();
        if (serviceType == null)
            throw new InvalidOperationException($"No service found for {typeof(TDto).Name}");

        var service = _serviceProvider.GetRequiredService(serviceType);
        var method = serviceType.GetMethod(methodName);
        if (method == null)
            throw new InvalidOperationException($"Method {methodName} not found on {serviceType.Name}");

        var result = method.Invoke(service, new[] { parameter });
        if (result is Task task)
            await task;
    }

    /// <summary>
    /// Gets dependent count for an entity
    /// </summary>
    private async Task<int> GetDependentCount<TDto>(Guid entityId)
    {
        try
        {
            var serviceType = GetServiceType<TDto>();
            if (serviceType == null) return 0;

            var service = _serviceProvider.GetRequiredService(serviceType);
            var method = serviceType.GetMethod("GetDependentCountAsync");
            if (method == null) return 0;

            var result = method.Invoke(service, new object[] { entityId });
            if (result is Task<int> task)
                return await task;
        }
        catch
        {
            // Ignore errors, return 0 as default
        }
        return 0;
    }

    /// <summary>
    /// Gets entity display name
    /// </summary>
    private string GetEntityDisplayName<TDto>()
    {
        var typeName = typeof(TDto).Name;
        if (typeName.EndsWith("Dto"))
            typeName = typeName.Substring(0, typeName.Length - 3);

        return typeName switch
        {
            "Customer" => "Kunde",
            "User" => "Benutzer",
            _ => typeName
        };
    }

    /// <summary>
    /// Gets display name for an entity instance
    /// </summary>
    private string GetEntityDisplayName(object entity)
    {
        var nameProps = new[] { "Name", "FirstName", "Email", "Title" };
        foreach (var propName in nameProps)
        {
            var prop = entity.GetType().GetProperty(propName);
            if (prop?.GetValue(entity) is string value && !string.IsNullOrEmpty(value))
            {
                if (propName == "FirstName")
                {
                    var lastNameProp = entity.GetType().GetProperty("LastName");
                    if (lastNameProp?.GetValue(entity) is string lastName && !string.IsNullOrEmpty(lastName))
                        return $"{value} {lastName}";
                }
                return value;
            }
        }

        var id = GetEntityId(entity);
        return $"{GetEntityDisplayName(entity.GetType())} {id}";
    }

    /// <summary>
    /// Gets display name for a string
    /// </summary>
    private string GetDisplayName(string name)
    {
        return name switch
        {
            "Customer" => "Firma",
            "User" => "Benutzer",
            _ => name
        };
    }

    /// <summary>
    /// Gets entity ID using reflection
    /// </summary>
    private Guid GetEntityId(object entity)
    {
        var idProp = entity.GetType().GetProperty("Id");
        if (idProp?.GetValue(entity) is Guid id)
            return id;
        throw new InvalidOperationException($"No Id property found on {entity.GetType().Name}");
    }

    /// <summary>
    /// Gets entity display name from type
    /// </summary>
    private string GetEntityDisplayName(Type type)
    {
        var typeName = type.Name;
        if (typeName.EndsWith("Dto"))
            typeName = typeName.Substring(0, typeName.Length - 3);

        return typeName switch
        {
            "Customer" => "Kunde",
            "User" => "Benutzer",
            _ => typeName
        };
    }

    /// <summary>
    /// Shows error dialog
    /// </summary>
    private void ShowError(string title, string message)
    {
        _dialogService.Open(new DialogRequest
        {
            Title = title,
            Message = message,
            ConfirmText = "OK",
            OnConfirm = () => Task.CompletedTask
        });
    }
}
=== ./Services/DialogServiceExtensions.cs ===
namespace CMC.Web.Services;

public static class DialogServiceExtensions
{
	// Overload, der zu: ConfirmDelete(title, async () => { ... }, entityTypeName) passt
	public static void ConfirmDelete(this DialogService dialogs, string title, Func<Task> onConfirm, string? entityTypeName = null)
	{
		var message = string.IsNullOrWhiteSpace(entityTypeName)
			? "Wirklich l√∂schen?"
			: $"{entityTypeName} wirklich l√∂schen?";

		dialogs.Open(new DialogRequest
		{
			Title = title,
			Message = message,
			ConfirmText = "L√∂schen",
			OnConfirm = onConfirm,
			CancelText = "Abbrechen",
			OnCancel = () => Task.CompletedTask
		});
	}

	// Klassischer Overload (falls woanders genutzt)
	public static void ConfirmDelete(this DialogService dialogs, string title, string message, Func<Task> onConfirm)
	{
		dialogs.Open(new DialogRequest
		{
			Title = title,
			Message = message,
			ConfirmText = "L√∂schen",
			OnConfirm = onConfirm,
			CancelText = "Abbrechen",
			OnCancel = () => Task.CompletedTask
		});
	}

	// Passt zu: ConfirmDeleteWithRelations(title, dependentCount, async (strategy) => { ... }, entityTypeName)
	public static void ConfirmDeleteWithRelations(this DialogService dialogs, string title, int dependentCount, Func<string, Task> onDecision, string? entityTypeName = null)
	{
		var msg = (dependentCount <= 0)
			? "Es existieren verkn√ºpfte Daten."
			: $"Es existieren {dependentCount} verkn√ºpfte Eintr√§ge.";

		var options = new List<DialogOption>
		{
			new("cascade", "Alles l√∂schen (Kaskade)"),
			new("detach",  "Verkn√ºpfungen l√∂sen, dann l√∂schen"),
			new("cancel",  "Abbrechen")
		};

		dialogs.Open(new ChoiceRequest
		{
			Title = string.IsNullOrWhiteSpace(entityTypeName) ? title : $"{title} ‚Äì {entityTypeName}",
			Message = msg,
			MultiSelect = false,
			Options = options,
			OnConfirm = async keys =>
			{
				var k = keys.FirstOrDefault() ?? "cancel";
				if (k == "cancel") return;
				await onDecision(k);
			},
			OnCancel = () => Task.CompletedTask,
			ConfirmText = "√úbernehmen",
			CancelText = "Abbrechen"
		});
	}
}
=== ./Services/DialogService.cs ===
namespace CMC.Web.Services;

public sealed record DialogOption(string Key, string Label, bool Selected = false);

public sealed class DialogRequest
{
    public string Title { get; init; } = "";
    public string Message { get; init; } = "";
    public string ConfirmText { get; init; } = "OK";
    public Func<Task>? OnConfirm { get; init; }
    public string? CancelText { get; init; }
    public Func<Task>? OnCancel { get; init; }
}

public sealed class ChoiceRequest
{
    public string Title { get; init; } = "Auswahl";
    public string Message { get; init; } = "";
    public bool MultiSelect { get; init; } = false;
    public IReadOnlyList<DialogOption> Options { get; init; } = Array.Empty<DialogOption>();
    public Func<IReadOnlyList<string>, Task>? OnConfirm { get; init; }
    public Func<Task>? OnCancel { get; init; }
    public string? ConfirmText { get; init; } = "√úbernehmen";
    public string? CancelText { get; init; } = "Abbrechen";
}

public class DialogService
{
    public event Action<DialogRequest>? OnOpen;
    public event Action<ChoiceRequest>? OnOpenChoice;

    public void Open(DialogRequest req) => OnOpen?.Invoke(req);
    public void Open(ChoiceRequest req) => OnOpenChoice?.Invoke(req);
}
=== ./Program.cs ===
// src/CMC.Web/Program.cs
using CMC.Infrastructure;
using CMC.Infrastructure.Persistence;
using Microsoft.EntityFrameworkCore;
using CMC.Application.Services;
using CMC.Web.Services;
using CMC.Web.Shared;
using CMC.Web.Auth; // CookieEvents
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.AspNetCore.HttpOverrides;

var builder = WebApplication.CreateBuilder(args);

// üîß SSL Development Fix ‚Äì nur im Development
if (builder.Environment.IsDevelopment())
{
    builder.WebHost.ConfigureKestrel(options =>
    {
        options.ConfigureHttpsDefaults(httpsOptions => { httpsOptions.ServerCertificate = null; });
    });
}

// Add services
builder.Services.AddRazorPages();
builder.Services.AddServerSideBlazor(options => { options.DetailedErrors = true; });
builder.Services.AddControllers();
builder.Services.AddSignalR(options =>
{
    options.EnableDetailedErrors = true;
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(60);
    options.HandshakeTimeout = TimeSpan.FromSeconds(30);
});

// HttpClient mit SSL-Bypass nur im Development
builder.Services.AddHttpClient("default", client =>
{
    client.Timeout = TimeSpan.FromSeconds(30);
})
.ConfigurePrimaryHttpMessageHandler(() =>
{
    var handler = new HttpClientHandler();
    if (builder.Environment.IsDevelopment())
        handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
    return handler;
});

// App-Services (DI)
builder.Services.AddScoped<DialogService>();
builder.Services.AddScoped<RelationDialogService>();
builder.Services.AddScoped<EditDrawerService>();
builder.Services.AddScoped<IRelationshipManager, RelationshipManager<AppDbContext>>();

// Authentication + Cookie Setup (Events ausgelagert)
builder.Services.AddScoped<CookieEvents>();
builder.Services
    .AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.Cookie.Name = "CMC_Auth";
        options.Cookie.HttpOnly = true;
        options.Cookie.SameSite = SameSiteMode.Lax;
        options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;

        options.ExpireTimeSpan = TimeSpan.FromDays(30);
        options.SlidingExpiration = true;
        options.Cookie.MaxAge = TimeSpan.FromDays(30);
        options.Cookie.Path = "/";
        options.Cookie.IsEssential = true;

        options.LoginPath = "/login";
        options.LogoutPath = "/api/auth/logout";
        options.AccessDeniedPath = "/login";

        // Keine Inline-Lambdas -> verhindert MissingMethodException bei Hot Reload
        options.EventsType = typeof(CookieEvents);
    });

builder.Services.AddAuthorization();
builder.Services.AddCascadingAuthenticationState();
builder.Services.AddHttpContextAccessor();

// Infrastruktur (ConnectionString via Config/Env)
builder.Services.AddInfrastructure(builder.Configuration);

var app = builder.Build();

// Forwarded Headers (wichtig hinter Nginx f√ºr HTTPS/Cookies)
var fwdOptions = new ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
};
// klarer & compilierbar: explizit listen leeren
fwdOptions.KnownNetworks.Clear();
fwdOptions.KnownProxies.Clear();
app.UseForwardedHeaders(fwdOptions);

// Pipeline
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}
else
{
    app.UseDeveloperExceptionPage();
    Console.WriteLine("üîß Development SSL Info:");
    Console.WriteLine("   dotnet dev-certs https --trust");
    Console.WriteLine("   oder nutze http://localhost:5000");
}

app.UseStaticFiles();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();
app.MapBlazorHub();
app.MapRazorPages();
app.MapFallbackToPage("/_Host");

// Datenbank-Migration
using (var scope = app.Services.CreateScope())
{
    try
    {
        var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        await context.Database.MigrateAsync();
        Console.WriteLine("‚úÖ Database migrations completed");
    }
    catch (Exception ex)
    {
        var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "‚ùå Database setup failed");
    }
}

Console.WriteLine("üöÄ Starting CMC application...");
Console.WriteLine("   üì° URLs kommen aus ASPNETCORE_URLS oder appsettings.json");

app.Run();

public partial class Program { }
